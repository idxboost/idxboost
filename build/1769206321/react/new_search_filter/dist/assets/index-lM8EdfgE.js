import{r as e,j as t}from"./react-vendor-CnO_ZB-6.js";import{b as n}from"./state-DbALYLXJ.js";import{f as a,U as s,g as o,u as r,d as i,h as l,i as c,j as m,k as d,m as p}from"./index-BZrSeWWF.js";import{aQ as u,aR as g,b as f,a as h,aS as v,aT as y,h as w,aU as b,aV as E,aW as k,aX as L,aY as M,aZ as C,a_ as x,a$ as j,aI as N,j as $,aa as P,G as _,b0 as O,b1 as I,b2 as A,b3 as T,az as S,b4 as Z,b5 as z,aK as H,b6 as D,b7 as F,b8 as R,f as B,b9 as V,aL as W}from"./index-BMFplzbj.js";import{_ as q}from"./vendor-CMABA041.js";import"./utils-Cg5OwTVl.js";import{centerMapByPoints as U,centerMapByRect as G}from"./mapOperations-DZWFYxTu.js";import{u as K}from"./useOutsideClick-CdiqAPpl.js";import{u as Q}from"./i18n-TlBH8u-u.js";const X=e=>{const t=e.split(","),n=parseFloat(t[0]),a=parseFloat(t[1]);return{lat:(n+parseFloat(t[2]))/2,lng:(a+parseFloat(t[3]))/2}},Y=e=>!!e?.getBounds()&&!!e?.getProjection(),J=({data:J=[],isLoading:ee=!1,blurred:te=!1})=>{const{t:ne}=Q(),ae=n(),{width:se}=r(),[oe,re]=e.useState(!1),ie=e.useRef(null);K(ie,function(e){const t=document.querySelector(".ms-sf-wrapper-sorter"),n=document.querySelector("#shareModal");if(t&&t.contains(e.target)||n&&n.contains(e.target))return;const a=document.getElementById("property-info-box");if(a){const e=a.getAttribute("data-position");e&&d(e)}});const[le]=N(),{map:ce,markerClusterer:me,freeHandPolygons:de}=f(),{currentLat:pe,currentLng:ue,zoom:ge,clusterMarkersActive:fe,maxNumberMarkers:he,favoriteIcon:ve}=$(),{viewOption:ye,filters:we,tempFilters:be,isFirstCenter:Ee,searchRunning:ke,count:Le,defaultLocation:Me,favorites:Ce}=h(),{editingCriteria:xe,selectedEditCategoryId:je}=P(),Ne=!(we.rect||Me.rect||we.polygon||we.keyword_main),$e=e.useRef(!0),Pe=e.useRef(fe),{draw:_e,disable:Oe,enable:Ie,paint:Ae,clear:Te}=(()=>{const t=n(),[a,s]=e.useState(""),{freeHandPolygons:o}=f(),{loading:r}=h(),i=e.useRef(null);e.useEffect(()=>{const e=v("--ibc--idx-primary-color");s(e)},[]),e.useEffect(()=>{if(o.data.length&&!r){const e=o.data.map(e=>y(e)).join(",");o.initial||t(w({polygon:e,rect:void 0,zm:void 0,keyword_main:void 0}))}},[o,t,r]);const l=e.useCallback((e,t)=>{const n=t.getZoom()||15,s=[];e.forEach(e=>s.push({lat:e.lat(),lng:e.lng()}));const o=((e,t)=>{let n,a,s,o,r,i,l,c,m,d,p,u,g,f,h,v,y,w,b=0;const E=Math.PI/180*.5,k=[],L=[],M=[];if(e.length<3)return e;for(b=e.length,m=360*t/(2*Math.PI*6378137),m*=m,a=0,L[0]=0,M[0]=b-1,n=1;n>0;)if(s=L[n-1],o=M[n-1],n--,o-s>1){for(d=e[o].lng-e[s].lng,p=e[o].lat-e[s].lat,Math.abs(d)>180&&(d=360-Math.abs(d)),d*=Math.cos(E*(e[o].lat+e[s].lat)),u=d*d+p*p,r=s+1,i=s,c=-1;r<o;r++)g=e[r].lng-e[s].lng,f=e[r].lat-e[s].lat,Math.abs(g)>180&&(g=360-Math.abs(g)),g*=Math.cos(E*(e[r].lat+e[s].lat)),h=g*g+f*f,v=e[r].lng-e[o].lng,y=e[r].lat-e[o].lat,Math.abs(v)>180&&(v=360-Math.abs(v)),v*=Math.cos(E*(e[r].lat+e[o].lat)),w=v*v+y*y,l=h>=u+w?w:w>=u+h?h:(g*p-f*d)*(g*p-f*d)/u,l>c&&(i=r,c=l);c<m?(k[a]=s,a++):(n++,L[n-1]=i,M[n-1]=o,n++,L[n-1]=s,M[n-1]=i)}else k[a]=s,a++;k[a]=b-1,a++;const C=[];for(let x=0;x<a;x++)C.push(e[k[x]]);return C})(s,20-n/20*19);return new google.maps.Polygon({map:t,paths:o,strokeColor:a,strokeOpacity:.8,strokeWeight:2,fillColor:a,fillOpacity:.2,clickable:!1})},[a]),c=e.useCallback((e,n)=>{if(o.data.forEach(e=>{e.setMap(null)}),t(b()),!n){if(e){const n=e.getCenter()?.lat()||0,a=e.getCenter()?.lng()||0,s=`${e.getZoom()||11}`,o=((e,t)=>{const n=document.getElementById("map"),a=n?.offsetWidth||window.innerWidth,s=n?.offsetHeight||window.innerHeight,o=Math.pow(2,t),r=180/(256*o)*s*1.8/2,i=360/(256*o)*a/2;return`${e.lat-r},${e.lng-i},${e.lat+r},${e.lng+i}`})({lat:n,lng:a},Number(s));t(w({rect:o,zm:s}))}t(w({polygon:void 0,keyword_main:void 0}))}},[o,t]),m=(e,n)=>{t(k(!1)),e.setOptions({draggable:!0}),i.current&&i.current.disconnect(),n&&(t(M(!0)),C())};return{draw:e=>{const n=e=>e.preventDefault();document.body.addEventListener("touchmove",n,{passive:!1});let s=new google.maps.Polyline({map:e,clickable:!1,strokeColor:a,strokeOpacity:.8,strokeWeight:2});const o=google.maps.event.addListener(e,"mousemove",function(e){s.getPath().push(e.latLng)});google.maps.event.addListenerOnce(e,"mouseup",function(){google.maps.event.removeListener(o);const a=s.getPath(),r=a.getLength()>1;r&&(s.setMap(null),s=l(a,e),t(E(s))),google.maps.event.clearListeners(e.getDiv(),"mousedown"),google.maps.event.clearListeners(e.getDiv(),"touchstart"),m(e,!r),document.body.removeEventListener("touchmove",n),u("off")})},paint:l,disable:e=>{t(k(!0)),e.setOptions({draggable:!1}),L(),t(M(!1));const n=new MutationObserver(()=>L());n.observe(document.body,{childList:!0,subtree:!0}),i.current=n},enable:m,clear:c}})(),{draw:Se,clear:Ze}=(()=>{const t=n(),{polygons:a,polygonVisibility:s}=f(),[o,r]=e.useState("");return e.useEffect(()=>{a.forEach(e=>e.setVisible(s))},[a,s]),e.useEffect(()=>{const e=v("--ibc--idx-primary-color");r(e)},[]),{draw:(e,...n)=>{e&&n.forEach(n=>{const a=new google.maps.Polygon({paths:n,strokeColor:o,strokeOpacity:.8,strokeWeight:2,fillColor:o,fillOpacity:.2});t(j(a)),a.setMap(e)})},clear:e.useCallback(()=>{a.forEach(e=>{e.setMap(null)}),t(x()),t(M(!0))},[a,t])}})(),[ze,He]=e.useState(null),[De,Fe]=e.useState(null);function Re(e){H({mlsNumber:e.mls_num,isSold:2===e.mls_status})}const Be=i(()=>{const e=ce?.getCenter(),t=e?.lat(),n=e?.lng(),a=ce?.getZoom();"map"!==ye||"edit"===_&&!xe||pe===t&&ue===n&&ge===a||(ae(D(t)),ae(F(n)),ae(R(a)),$e.current?$e.current=!1:ke?ae(B(!1)):Ee?ae(V(!1)):we.polygon||we.keyword_main||ae(w({rect:ce?.getBounds()?.toUrlValue(),zm:ce?.getZoom()?.toString()})))},700),Ve=()=>{ce&&(ze&&(google.maps.event.removeListener(ze),He(null)),De&&(google.maps.event.removeListener(De),Fe(null)),Ie(ce,!0),u("off"))};function We(e){const t=p(e,ne);W(t)}const qe=async()=>{const e=we.rect||Me.rect,t=e?X(e):void 0,n=Number(we.zm||Me.zm),a=new google.maps.Map(document.getElementById("map"),{center:t,zoom:n,mapId:"m4p1D",zoomControl:!1,mapTypeControl:!1,scaleControl:!1,rotateControl:!1,fullscreenControl:!1,clickableIcons:!1,panControl:!1,gestureHandling:"greedy",streetViewControl:!1,minZoom:4,maxZoom:20}),s=(e=>{const t=document.createElement("button");return t.className="ms-sf-btn sf-icon-zoom ",t.ariaLabel="Zoom In",t.addEventListener("click",()=>{if(!e)return;const t=e.getZoom()+1;e.setZoom(t)}),t})(a),o=(e=>{const t=document.createElement("button");return t.className="ms-sf-btn sf-icon-min ",t.ariaLabel="Zoom Out",t.addEventListener("click",()=>{if(!e)return;const t=e.getZoom()-1;e.setZoom(t)}),t})(a),r=(e=>{const t=document.createElement("button");return t.className="ms-sf-btn sf-icon-satellite",t.ariaLabel="Satellite View",t.addEventListener("click",()=>{const n=["roadmap","satellite"];let a=0;if(n.forEach((t,n)=>{t===e.getMapTypeId()&&(a=n)}),e.setMapTypeId(n[1===a?0:a+1]),1===a)return t.classList.remove("sf-icon-guide"),void t.classList.add("sf-icon-satellite");t.classList.remove("sf-icon-satellite"),t.classList.add("sf-icon-guide")}),t})(a),i=((e,t,n)=>{const s=document.createElement("button");return s.className="ms-sf-btn sf-icon-draw ms-sf-draw-control",s.ariaLabel="Draw Area",n&&(s.style.display="none"),s.addEventListener("click",()=>{u("on"),(()=>{if(!a)return;Oe(a);const e=google.maps.event.addDomListenerOnce(a.getDiv(),"touchstart",()=>_e(a)),t=google.maps.event.addDomListenerOnce(a.getDiv(),"mousedown",()=>_e(a));He(e),Fe(t)})?.()}),s})(0,0,"edit"===_),l=(e=>{const t=document.createElement("button");return t.className="ms-sf-btn sf-icon-location",t.ariaLabel="Location",t.addEventListener("click",async()=>{const{findCurrentLocation:t}=await q(()=>import("./mapOperations-DZWFYxTu.js"),__vite__mapDeps([]),import.meta.url);t(e)}),t})(a),c=document.createElement("div");c.className="ms-sf-item",c.appendChild(s),c.appendChild(o),c.appendChild(i),c.appendChild(r),c.appendChild(l);const m=document.createElement("div");if(m.className="ms-sf-wrapper-map-actions",m.appendChild(c),a.controls[google.maps.ControlPosition.TOP_RIGHT].push(m),!e&&we.polygon){const e=we.polygon.split(",").map(e=>g(e)).flatMap(e=>{const t=[];return e.forEach(e=>t.push({lat:e.lat(),lng:e.lng()})),t});U(e,a)}ae(z(a))};e.useEffect(()=>{if(!ce||"map"!==ye||!_)return;const e=e=>{const t="new"===_||!!xe;e.style.display=t?"flex":"none",t||(Ve(),u("off"))},t=()=>ce.getDiv().querySelector(".ms-sf-draw-control");let n=t();if(n)return void e(n);const a=ce.addListener("idle",()=>{n=t(),n&&(e(n),a.remove(),o?.disconnect())}),s=ce.getDiv(),o=new MutationObserver(()=>{n=t(),n&&(e(n),a.remove?.(),o.disconnect())});return o.observe(s,{childList:!0,subtree:!0}),()=>{a.remove?.(),o.disconnect()}},[ce,ye,xe]),e.useEffect(()=>{Ne||ce||qe()},[Ne,ce]),e.useEffect(()=>{if(!ce)return;const e=()=>{Ze()},t=e=>{const t=e,{coords:n}=t.detail;Se(ce,...n)},n=e=>{const t=e,{skipFilterUpdate:n}=t.detail||{};Te(ce,n)},a=e=>{const t=e,{paths:n,shouldHide:a}=t.detail,s=n.map(e=>Ae(e,ce));a&&s.forEach(e=>e.setVisible(!1)),ae(Z({initial:!0,data:s}))},s=e=>{const t=e,{points:n}=t.detail;U(n,ce)},o=e=>{const t=e,{rect:n,zm:a}=t.detail;G({rect:n,zm:a},ce)};return window.addEventListener("map:clearPolygons",e),window.addEventListener("map:drawPolygons",t),window.addEventListener("map:clearFreeHand",n),window.addEventListener("map:paintFreeHand",a),window.addEventListener("map:centerByPoints",s),window.addEventListener("map:centerByRect",o),()=>{window.removeEventListener("map:clearPolygons",e),window.removeEventListener("map:drawPolygons",t),window.removeEventListener("map:clearFreeHand",n),window.removeEventListener("map:paintFreeHand",a),window.removeEventListener("map:centerByPoints",s),window.removeEventListener("map:centerByRect",o)}},[ce,Ze,Se,Ie,Ae,ae]);const Ue=e.useMemo(()=>l(J),[J]);return e.useEffect(()=>{if(!ce)return;const e=ce.addListener("click",()=>c());return()=>e.remove()},[ce]),e.useEffect(()=>{if(!ce)return;let e=!1;return(async()=>{const{AdvancedMarkerElement:t}=await google.maps.importLibrary("marker");let n=me;if(!n||Pe.current!==fe){if(n&&(n.clearMarkers?.(!0),n.setMap(null)),n=await(async({markers:e,map:t,markerGrouping:n=!1})=>{const{AdvancedMarkerElement:s}=await google.maps.importLibrary("marker"),{MarkerClusterer:o,SuperClusterAlgorithm:r}=await a(),i=new o({markers:e,map:t,algorithm:new r({maxZoom:n&&14,radius:120}),renderer:{render:({markers:e,position:t})=>(({amount:e,position:t,AdvancedMarkerElement:n})=>{const a=document.createElement("div");a.className="MarkerClustererElement";const s=Math.min(e+26,50);return a.style.height=s+10+"px",a.style.width=s+10+"px",a.innerHTML=`\n    <div \n      style="width: ${s}px; height: ${s}px;"\n    >\n      ${e}\n    </div>\n    `,new n({position:t,content:a})})({position:t,amount:e?.length||0,AdvancedMarkerElement:s})}});return i})({markers:[],map:ce,markerGrouping:fe}),Pe.current=fe,e)return;ae(O(n))}const r=Ue.map(e=>function({properties:e,AdvancedMarkerElement:t,handleClick:n,favoriteIcon:a,favoriteCTA:r,shareCTA:i,t:l,attachToMap:c=!1,map:m}){const d=e[0],p=`${d.lat},${d.lng}`,u=document.createElement("div");if(u.className="ms-sf-richmarker",u.id=p,u.title=e.map(({mls_num:e})=>e).join(","),e.length>1)u.innerHTML=`<span class="ms-sf-price">${e.length} ${l("Units")}</span>`;else{const e=2===d.mls_status?d.price_sold||0:d.price,t=null===d?.reduced_price||isNaN(d?.reduced_price)?0:d?.reduced_price;u.innerHTML=`\n      <span class="ms-sf-price">\n        ${0===e?"N/A":s.format(e)}\n        ${t?`<i class="sf-icon-arrow-back ${t<0?"-down":"-up"}"></i>`:""}\n      </span>`}const g=new t({position:{lat:Number(d.lat),lng:Number(d.lng)},content:u,...c&&m?{map:m}:{}});return g.addListener("click",()=>o({properties:e,favoriteIcon:a,favoriteCTA:r,shareCTA:i,handleClick:n,t:l})),g}({properties:e,AdvancedMarkerElement:t,handleClick:Re,favoriteIcon:ve,favoriteCTA:le,shareCTA:We,t:ne,attachToMap:!1})),i=(e=>e.filter(e=>!!e.position))(r);if("function"==typeof n.setMarkers)n.setMarkers(i);else if(n.clearMarkers?.(!0),i.length>0){n.addMarkers?.(i,!0);const e=()=>{Y(ce)&&i.length>0&&n.render()};Y(ce)?e():google.maps.event.addListenerOnce(ce,"idle",e)}else Y(ce)&&n.render();re(!0)})(),()=>{e=!0}},[ce,Ue,fe]),e.useEffect(()=>{me&&(oe||Ce)&&((me?.markers||[]).forEach(e=>{const t=e.targetElement,n=I(t);if(!n)return;const a=n.split(",");if(!(a.length>1)){const e=a.some(e=>!!Ce[e]);A(t,ve,e)}a.forEach(e=>{T(e,!!Ce[e])}),t.onclick=()=>{a.forEach(e=>{T(e,!!Ce[e])})}}),re(!1))},[Ce,ve,me,oe]),e.useEffect(()=>{!ce||J.length||!we.keyword_main||we.rect||Me.rect||we.zm||Me.zm||!Object.entries(be).length||(ce.setCenter(X(`${be.rect}`)),ce.setZoom(Number(be.zm)))},[ce,J,we,be]),e.useEffect(()=>{let e;return ce&&(e=ce.addListener("bounds_changed",Be)),()=>{e?.remove()}},[ce,ae,Be]),e.useEffect(()=>{setTimeout(()=>{const e=S("all"),t=window.innerHeight-e,n=document.querySelector("#map"),a=document.querySelector(".ms-sf-filter-map");n.style.transition="height 0.2s ease, top 0.2s ease",n.style.height=`${t||0}px`,n.style.top=`${e}px`,a.style.transition="height 0.2s ease, top 0.2s ease",a.style.height=`${t||0}px`,a.style.top=`${e}px`},400)},[se,je]),e.useEffect(()=>{if(!ce?.get("mapId"))return;if(de.data.length<=1)return;let e=!1;return(async()=>{const{cleanCoords:t,multiPoint:n,polygon:a,featureCollection:s,union:o,unkink:r}=await m();if(e)return;const i=de.data.map(e=>t(n(e.getPath().getArray().map(e=>[e.lat(),e.lng()]))).geometry.coordinates).filter(e=>e.length>=4).map(e=>e.map(e=>new google.maps.LatLng(e[0],e[1]))).map(e=>r(e)).flatMap(e=>e.features.map(e=>e.geometry.coordinates[0])).filter(e=>e.length>=4);if(e)return;if(i.length<2)return void Ve();const l=e=>{if(!e.length)return e;const[t,n]=e[0],[a,s]=e[e.length-1];return t===a&&n===s?e:[...e,[t,n]]},c=o(s(i.map(e=>a([l(e)]))));if(c){if(de.data.forEach(e=>e.setMap(null)),"Polygon"===c.geometry.type){const e=Ae(c.geometry.coordinates[0].map(e=>new google.maps.LatLng(e[1],e[0])),ce);ae(Z({initial:!1,data:[e]}))}if("MultiPolygon"===c.geometry.type){const e=[];c.geometry.coordinates.forEach(t=>{const n=t[0],a=Ae(n.map(e=>new google.maps.LatLng(e[1],e[0])),ce);e.push(a)}),ae(Z({initial:!1,data:e}))}}})(),()=>{e=!0}},[de.data.length,ce?.get("mapId")]),t.jsxs("div",{id:"map-container",className:`ms-sf-filter-map ${Ne?"-loading":""} `,children:[!ee&&Le>he&&!fe&&t.jsxs("div",{className:"ms-sf-markers-count-alert",children:[t.jsx("span",{children:`${ne("Showing")} ${J.length} ${ne("of")} ${Le?.toLocaleString("en")||0} ${ne("properties")}.`}),t.jsx("span",{children:ne("Zoom in to see more.")})]}),t.jsxs("div",{className:"ms-sf-wrapper-draw-map-header",children:[t.jsx("span",{children:ne("Draw a shape around the region(s) you would like to live in")}),t.jsx("div",{className:"ms-sf-flex",children:t.jsx("button",{className:"ms-sf-btn -cancel",onClick:Ve,children:ne("Cancel")})})]}),t.jsx("div",{ref:ie,id:"property-info-box"}),t.jsx("div",{className:"ms-sf-map-loading-layout",children:t.jsx("div",{className:"sf-icon-map"})}),t.jsx("div",{id:"map",className:"ms-sf-filter-map "+(te?"-blurred":"")})]})};export{J as default};
function __vite__mapDeps(indexes) {
  if (!__vite__mapDeps.viteFileDeps) {
    __vite__mapDeps.viteFileDeps = []
  }
  return indexes.map((i) => __vite__mapDeps.viteFileDeps[i])
}
