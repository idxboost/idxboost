const d=i=>/(?:youtube\.com\/(?:watch\?v=|embed\/)|youtu\.be\/)/.test(i)?"youtube":/(?:vimeo\.com\/(?:video\/)?|player\.vimeo\.com\/video\/)/.test(i)?"vimeo":"html5",y=(i,e)=>{if(i==="youtube"){const t=e.match(/(?:youtube\.com\/(?:watch\?v=|embed\/)|youtu\.be\/)([a-zA-Z0-9_-]{11})/);return t?t[1]:null}if(i==="vimeo"){const t=e.match(/(?:vimeo\.com\/(?:video\/)?|player\.vimeo\.com\/video\/)?(\d+)/);return t?t[1]:null}return e},c=(i,e)=>{const t=document.createElement("button");return t.textContent=i,t.className=e,t},m=()=>{const i=document.createElement("div");i.className="ms-custom-player-progress-container";const e=document.createElement("div");return e.className="ms-custom-player-progress-bar",i.appendChild(e),{container:i,bar:e}},n=i=>{i=Math.floor(i);const e=Math.floor(i/60),t=i%60;return`${e}:${t.toString().padStart(2,"0")}`};class p{constructor(e,t){if(this.container=e,e.querySelector(".ms-custom-player-wrapper")){console.warn("Ya existe un wrapper en este contenedor. Cancelando inicializaciÃ³n.");return}this.srcRaw=e.dataset.src,this.autoplay=e.dataset.autoplay==="true",this.muted=e.dataset.muted==="true",this.loop=e.dataset.loop==="true",this.type=d(this.srcRaw),this.src=y(this.type,this.srcRaw),this.src&&(this.wrapper=document.createElement("div"),this.wrapper.classList.add("ms-custom-player-wrapper"),this.container.appendChild(this.wrapper),this.id=`${this.type}-player-${t}-${Math.floor(Math.random()*1e4)}`,this.createPlayer())}createPlayer(){this.type==="html5"?(this.createHTML5Player(),this.createControls(),this.attachHTML5Events()):this.type==="youtube"?this.createYouTubePlayer():this.type==="vimeo"&&this.createVimeoPlayer()}createHTML5Player(){this.player=document.createElement("video"),this.player.src=this.src,this.player.autoplay=this.autoplay,this.player.muted=this.muted,this.player.loop=this.loop,this.player.controls=!1,this.player.playsInline=!0,this.wrapper.appendChild(this.player)}attachHTML5Events(){this.player.addEventListener("timeupdate",()=>this.updateProgress()),this.player.addEventListener("play",()=>this.onPlay()),this.player.addEventListener("pause",()=>this.onPause()),this.player.addEventListener("volumechange",()=>this.onVolumeChange()),this.player.addEventListener("loadedmetadata",()=>this.updateProgress())}onPlay(){this.playBtn.classList.add("active"),this.extraPlayBtn.classList.add("active")}onPause(){this.playBtn.classList.remove("active"),this.extraPlayBtn.classList.remove("active")}onVolumeChange(){this.muteBtn.classList.toggle("active",this.player.muted)}updateProgress(){const e=this.player.currentTime,t=this.player.duration||0,s=t?e/t*100:0;this.progressBar.style.width=`${s}%`,this.timeDisplay.textContent=`${n(e)} / ${n(t)}`}createYouTubePlayer(){const e=()=>{if(window.YT&&window.YT.Player)for(console.log("YT.Player is now ready, processing queue");window.youTubePlayersQueue.length;)window.youTubePlayersQueue.shift()();else console.log("YT.Player still not ready, checking again..."),setTimeout(e,500)},t=()=>{if(!window.YT){console.log("Loading YouTube IFrame API...");const a=document.createElement("script");a.src="https://www.youtube.com/iframe_api";const o=document.getElementsByTagName("script")[0];o.parentNode.insertBefore(a,o)}window.youTubePlayersQueue||(window.youTubePlayersQueue=[]),window.onYouTubeIframeAPIReady||(window.onYouTubeIframeAPIReady=()=>{for(console.log("YouTube API is ready, processing queue");window.youTubePlayersQueue.length;)window.youTubePlayersQueue.shift()()})},s=document.createElement("div");s.id=this.id,this.wrapper.appendChild(s),window.YT&&window.YT.Player?this.initYouTube():(console.log("YT.Player not ready, adding to queue"),window.youTubePlayersQueue||(window.youTubePlayersQueue=[]),window.youTubePlayersQueue.push(this.initYouTube.bind(this)),t(),e())}initYouTube(){setTimeout(()=>{this.player=new YT.Player(this.id,{videoId:this.src,playerVars:{autoplay:this.autoplay?1:0,mute:this.muted?1:0,loop:this.loop?1:0,playlist:this.loop?this.src:void 0,controls:0,modestbranding:1,rel:0},events:{onReady:()=>{this.createControls(),this.attachYouTubeEvents(),this.syncInitialControlStates()},onStateChange:e=>this.onYouTubeStateChange(e)}})},0)}attachYouTubeEvents(){this.progressUpdateYT=setInterval(()=>{if(!this.player||this.player.getPlayerState()!==YT.PlayerState.PLAYING)return;const e=this.player.getCurrentTime(),t=this.player.getDuration();if(t>0){const s=e/t*100;this.progressBar.style.width=`${s}%`,this.timeDisplay.textContent=`${n(e)} / ${n(t)}`}},500)}onYouTubeStateChange(e){e.data===YT.PlayerState.PLAYING?(this.playBtn.classList.add("active"),this.extraPlayBtn.classList.add("active")):(e.data===YT.PlayerState.PAUSED||e.data===YT.PlayerState.ENDED)&&(this.playBtn.classList.remove("active"),this.extraPlayBtn.classList.remove("active"))}createVimeoPlayer(){const e=()=>{this.iframe=document.createElement("iframe"),this.iframe.src=`https://player.vimeo.com/video/${this.src}?autoplay=${this.autoplay?1:0}&muted=${this.muted?1:0}&loop=${this.loop?1:0}&background=1&controls=0`,this.iframe.allow="autoplay; fullscreen",this.iframe.allowFullscreen=!0,this.wrapper.appendChild(this.iframe),this.player=new Vimeo.Player(this.iframe),this.player.ready().then(()=>{this.createControls(),this.attachVimeoEvents(),this.syncInitialControlStates()})},t=()=>{if(window.Vimeo&&window.Vimeo.Player)for(;window.vimeoPlayersQueue.length;)window.vimeoPlayersQueue.shift()();else setTimeout(t,500)},s=()=>{if(!window.Vimeo||!window.Vimeo.Player){const a=document.createElement("script");a.src="https://player.vimeo.com/api/player.js",document.head.appendChild(a)}window.vimeoPlayersQueue||(window.vimeoPlayersQueue=[])};window.Vimeo&&window.Vimeo.Player?e():(window.vimeoPlayersQueue||(window.vimeoPlayersQueue=[]),window.vimeoPlayersQueue.push(e),s(),t())}attachVimeoEvents(){this.player.on("timeupdate",e=>{const t=e.seconds,s=e.duration,a=s?t/s*100:0;this.progressBar.style.width=`${a}%`,this.timeDisplay.textContent=`${n(t)} / ${n(s)}`}),this.player.on("play",()=>{this.playBtn.classList.add("active"),this.extraPlayBtn.classList.add("active")}),this.player.on("pause",()=>{this.playBtn.classList.remove("active"),this.extraPlayBtn.classList.remove("active")}),this.player.on("volumechange",()=>{this.player.getMuted().then(e=>{this.muteBtn.classList.toggle("active",e)})})}createControls(){this.controls=document.createElement("div"),this.controls.classList.add("ms-custom-player-controls"),this.playBtn=c("Play","play-toggle"),this.controls.appendChild(this.playBtn),this.muteBtn=c("Mute","mute-toggle"),this.controls.appendChild(this.muteBtn),this.timeDisplay=document.createElement("div"),this.timeDisplay.className="time",this.timeDisplay.textContent="0:00 / 0:00",this.controls.appendChild(this.timeDisplay);const{container:e,bar:t}=m();this.progressContainer=e,this.progressBar=t,this.controls.appendChild(this.progressContainer),this.fsBtn=c("Fullscreen","fullscreen-toggle"),this.controls.appendChild(this.fsBtn),this.wrapper.appendChild(this.controls),this.extraPlayBtn=c("Extra Play","ms-custom-extra-play-btn"),this.wrapper.appendChild(this.extraPlayBtn),this.addControlListeners(),this.handleProgressDrag()}addControlListeners(){const e=/iPad|iPhone|iPod/.test(navigator.userAgent)&&!window.MSStream,t=()=>{this.type==="html5"?this.player.paused?this.player.play():this.player.pause():this.type==="youtube"?this.player.getPlayerState()!==YT.PlayerState.PLAYING?this.player.playVideo():this.player.pauseVideo():this.type==="vimeo"&&this.player.getPaused().then(s=>{s?this.player.play():this.player.pause()})};this.playBtn.addEventListener("click",t),this.extraPlayBtn.addEventListener("click",t),this.muteBtn.addEventListener("click",()=>{this.type==="html5"?(this.player.muted=!this.player.muted,this.muteBtn.classList.toggle("active",this.player.muted)):this.type==="youtube"?this.player.isMuted()?(this.player.unMute(),this.muteBtn.classList.remove("active")):(this.player.mute(),this.muteBtn.classList.add("active")):this.type==="vimeo"&&this.player.getMuted().then(s=>{this.player.setMuted(!s).then(()=>{this.muteBtn.classList.toggle("active",!s)}).catch(a=>{console.warn("No se pudo cambiar el mute en Vimeo:",a)})})}),document.addEventListener("fullscreenchange",()=>{const s=document.fullscreenElement===this.wrapper;this.fsBtn.classList.toggle("active",s)}),this.fsBtn.addEventListener("click",()=>{e&&this.type==="html5"&&typeof this.player.webkitEnterFullscreen=="function"?this.player.webkitEnterFullscreen():document.fullscreenElement?document.exitFullscreen():this.wrapper.requestFullscreen().catch(s=>{console.warn("Error al entrar en fullscreen:",s)})}),e&&(this.type==="youtube"||this.type==="vimeo")&&(this.fsBtn.style.display="none")}handleProgressDrag(){let e=!1;const t=o=>{if(!e)return;o.preventDefault();const r=this.progressContainer.getBoundingClientRect();let l=(o.touches?o.touches[0].clientX:o.clientX)-r.left;l=Math.max(0,Math.min(l,r.width));const h=l/r.width;this.progressBar.style.width=`${h*100}%`,this.updateTimeDisplayDuringDrag(h)},s=o=>{if(!e)return;e=!1,o.preventDefault();const r=this.progressContainer.getBoundingClientRect();let l=(o.changedTouches?o.changedTouches[0].clientX:o.clientX)-r.left;l=Math.max(0,Math.min(l,r.width));const h=l/r.width;this.seekTo(h)},a=o=>{o.preventDefault(),e=!0,t(o)};this.progressContainer.addEventListener("mousedown",a),window.addEventListener("mousemove",t),window.addEventListener("mouseup",s),this.progressContainer.addEventListener("touchstart",a,{passive:!1}),window.addEventListener("touchmove",t,{passive:!1}),window.addEventListener("touchend",s)}updateTimeDisplayDuringDrag(e){const t=s=>{const a=s*e;this.timeDisplay.textContent=`${n(a)} / ${n(s)}`};this.type==="html5"?t(this.player.duration||0):this.type==="vimeo"?this.player.getDuration().then(t):this.type==="youtube"&&t(this.player.getDuration())}seekTo(e){this.type==="html5"?this.player.currentTime=e*this.player.duration:this.type==="vimeo"?this.player.getDuration().then(t=>this.player.setCurrentTime(t*e)):this.type==="youtube"&&this.player.seekTo(this.player.getDuration()*e,!0)}syncInitialControlStates(){if(this.type==="html5")this.playBtn.classList.toggle("active",!this.player.paused),this.extraPlayBtn.classList.toggle("active",!this.player.paused),this.muteBtn.classList.toggle("active",this.player.muted),this.updateProgress();else if(this.type==="youtube"){const e=this.player.getPlayerState()===YT.PlayerState.PLAYING;this.playBtn.classList.toggle("active",e),this.extraPlayBtn.classList.toggle("active",e),this.muteBtn.classList.toggle("active",this.player.isMuted())}else this.type==="vimeo"&&(this.player.getPaused().then(e=>{this.playBtn.classList.toggle("active",!e),this.extraPlayBtn.classList.toggle("active",!e)}),this.player.getMuted().then(e=>this.muteBtn.classList.toggle("active",e)))}}const g=()=>{const i=document.querySelectorAll(".ms-custom-player"),e={root:null,rootMargin:"0px",threshold:.25},t=new IntersectionObserver((s,a)=>{s.forEach(o=>{if(o.isIntersecting){const r=o.target,u=[...i].indexOf(r);new p(r,u),a.unobserve(r)}})},e);i.forEach(s=>t.observe(s))};window.CustomPlayer=p;window.initializeCustomPlayer=g;
