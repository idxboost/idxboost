import{r as e,j as t}from"./react-vendor-CnO_ZB-6.js";import{b as n}from"./state-DbALYLXJ.js";import{f as a,U as s,g as o,u as r,d as i,h as l,i as c,j as m,k as d,m as p}from"./index-D9wFayYK.js";import{aN as u,aO as g,b as f,a as h,aP as v,aQ as y,h as w,aR as b,aS as E,aT as k,aU as L,aV as M,aW as C,aX as x,aY as j,aG as N,i as $,a8 as P,E as O,aZ as _,a_ as I,a$ as T,b0 as A,ax as S,b1 as Z,b2 as z,aI as H,b3 as D,b4 as F,b5 as R,f as B,b6 as V,aJ as W}from"./index-D8xEFLQL.js";import{_ as q}from"./vendor-CMABA041.js";import"./utils-Cg5OwTVl.js";import{centerMapByPoints as U,centerMapByRect as G}from"./mapOperations-DZWFYxTu.js";import{u as J}from"./useOutsideClick-CdiqAPpl.js";import{u as Q}from"./i18n-TlBH8u-u.js";const X=e=>{const t=e.split(","),n=parseFloat(t[0]),a=parseFloat(t[1]);return{lat:(n+parseFloat(t[2]))/2,lng:(a+parseFloat(t[3]))/2}},Y=e=>!!e?.getBounds()&&!!e?.getProjection(),K=({data:K=[],isLoading:ee=!1})=>{const{t:te}=Q(),ne=n(),{width:ae}=r(),[se,oe]=e.useState(!1),re=e.useRef(null);J(re,function(e){const t=document.querySelector(".ms-sf-wrapper-sorter"),n=document.querySelector("#shareModal");if(t&&t.contains(e.target)||n&&n.contains(e.target))return;const a=document.getElementById("property-info-box");if(a){const e=a.getAttribute("data-position");e&&d(e)}});const[ie]=N(),{map:le,markerClusterer:ce,freeHandPolygons:me}=f(),{currentLat:de,currentLng:pe,zoom:ue,clusterMarkersActive:ge,maxNumberMarkers:fe,favoriteIcon:he}=$(),{viewOption:ve,filters:ye,tempFilters:we,isFirstCenter:be,searchRunning:Ee,count:ke,defaultLocation:Le,favorites:Me}=h(),{editingCriteria:Ce,selectedEditCategoryId:xe}=P(),je=!(ye.rect||Le.rect||ye.polygon||ye.keyword_main),Ne=e.useRef(!0),$e=e.useRef(ge),{draw:Pe,disable:Oe,enable:_e,paint:Ie,clear:Te}=(()=>{const t=n(),[a,s]=e.useState(""),{freeHandPolygons:o}=f(),{loading:r}=h(),i=e.useRef(null);e.useEffect(()=>{const e=v("--ibc--idx-primary-color");s(e)},[]),e.useEffect(()=>{if(o.data.length&&!r){const e=o.data.map(e=>y(e)).join(",");o.initial||t(w({polygon:e,rect:void 0,zm:void 0,keyword_main:void 0}))}},[o,t,r]);const l=e.useCallback((e,t)=>{const n=t.getZoom()||15,s=[];e.forEach(e=>s.push({lat:e.lat(),lng:e.lng()}));const o=((e,t)=>{let n,a,s,o,r,i,l,c,m,d,p,u,g,f,h,v,y,w,b=0;const E=Math.PI/180*.5,k=[],L=[],M=[];if(e.length<3)return e;for(b=e.length,m=360*t/(2*Math.PI*6378137),m*=m,a=0,L[0]=0,M[0]=b-1,n=1;n>0;)if(s=L[n-1],o=M[n-1],n--,o-s>1){for(d=e[o].lng-e[s].lng,p=e[o].lat-e[s].lat,Math.abs(d)>180&&(d=360-Math.abs(d)),d*=Math.cos(E*(e[o].lat+e[s].lat)),u=d*d+p*p,r=s+1,i=s,c=-1;r<o;r++)g=e[r].lng-e[s].lng,f=e[r].lat-e[s].lat,Math.abs(g)>180&&(g=360-Math.abs(g)),g*=Math.cos(E*(e[r].lat+e[s].lat)),h=g*g+f*f,v=e[r].lng-e[o].lng,y=e[r].lat-e[o].lat,Math.abs(v)>180&&(v=360-Math.abs(v)),v*=Math.cos(E*(e[r].lat+e[o].lat)),w=v*v+y*y,l=h>=u+w?w:w>=u+h?h:(g*p-f*d)*(g*p-f*d)/u,l>c&&(i=r,c=l);c<m?(k[a]=s,a++):(n++,L[n-1]=i,M[n-1]=o,n++,L[n-1]=s,M[n-1]=i)}else k[a]=s,a++;k[a]=b-1,a++;const C=[];for(let x=0;x<a;x++)C.push(e[k[x]]);return C})(s,20-n/20*19);return new google.maps.Polygon({map:t,paths:o,strokeColor:a,strokeOpacity:.8,strokeWeight:2,fillColor:a,fillOpacity:.2,clickable:!1})},[a]),c=e.useCallback((e,n)=>{if(o.data.forEach(e=>{e.setMap(null)}),t(b()),!n){if(e){const n=e.getCenter()?.lat()||0,a=e.getCenter()?.lng()||0,s=`${e.getZoom()||11}`,o=((e,t)=>{const n=document.getElementById("map"),a=n?.offsetWidth||window.innerWidth,s=n?.offsetHeight||window.innerHeight,o=Math.pow(2,t),r=180/(256*o)*s*1.8/2,i=360/(256*o)*a/2;return`${e.lat-r},${e.lng-i},${e.lat+r},${e.lng+i}`})({lat:n,lng:a},Number(s));t(w({rect:o,zm:s}))}t(w({polygon:void 0,keyword_main:void 0}))}},[o,t]),m=(e,n)=>{t(k(!1)),e.setOptions({draggable:!0}),i.current&&i.current.disconnect(),n&&(t(M(!0)),C())};return{draw:e=>{const n=e=>e.preventDefault();document.body.addEventListener("touchmove",n,{passive:!1});let s=new google.maps.Polyline({map:e,clickable:!1,strokeColor:a,strokeOpacity:.8,strokeWeight:2});const o=google.maps.event.addListener(e,"mousemove",function(e){s.getPath().push(e.latLng)});google.maps.event.addListenerOnce(e,"mouseup",function(){google.maps.event.removeListener(o);const a=s.getPath(),r=a.getLength()>1;r&&(s.setMap(null),s=l(a,e),t(E(s))),google.maps.event.clearListeners(e.getDiv(),"mousedown"),google.maps.event.clearListeners(e.getDiv(),"touchstart"),m(e,!r),document.body.removeEventListener("touchmove",n),u("off")})},paint:l,disable:e=>{t(k(!0)),e.setOptions({draggable:!1}),L(),t(M(!1));const n=new MutationObserver(()=>L());n.observe(document.body,{childList:!0,subtree:!0}),i.current=n},enable:m,clear:c}})(),{draw:Ae,clear:Se}=(()=>{const t=n(),{polygons:a,polygonVisibility:s}=f(),[o,r]=e.useState("");return e.useEffect(()=>{a.forEach(e=>e.setVisible(s))},[a,s]),e.useEffect(()=>{const e=v("--ibc--idx-primary-color");r(e)},[]),{draw:(e,...n)=>{e&&n.forEach(n=>{const a=new google.maps.Polygon({paths:n,strokeColor:o,strokeOpacity:.8,strokeWeight:2,fillColor:o,fillOpacity:.2});t(j(a)),a.setMap(e)})},clear:e.useCallback(()=>{a.forEach(e=>{e.setMap(null)}),t(x()),t(M(!0))},[a,t])}})(),[Ze,ze]=e.useState(null),[He,De]=e.useState(null);function Fe(e){H({mlsNumber:e.mls_num,isSold:2===e.mls_status})}const Re=i(()=>{const e=le?.getCenter(),t=e?.lat(),n=e?.lng(),a=le?.getZoom();"map"!==ve||"edit"===O&&!Ce||de===t&&pe===n&&ue===a||(ne(D(t)),ne(F(n)),ne(R(a)),Ne.current?Ne.current=!1:Ee?ne(B(!1)):be?ne(V(!1)):ye.polygon||ye.keyword_main||ne(w({rect:le?.getBounds()?.toUrlValue(),zm:le?.getZoom()?.toString()})))},700),Be=()=>{le&&(Ze&&(google.maps.event.removeListener(Ze),ze(null)),He&&(google.maps.event.removeListener(He),De(null)),_e(le,!0),u("off"))};function Ve(e){const t=p(e,te);W(t)}const We=async()=>{const e=ye.rect||Le.rect,t=e?X(e):void 0,n=Number(ye.zm||Le.zm),a=new google.maps.Map(document.getElementById("map"),{center:t,zoom:n,mapId:"m4p1D",zoomControl:!1,mapTypeControl:!1,scaleControl:!1,rotateControl:!1,fullscreenControl:!1,clickableIcons:!1,panControl:!1,gestureHandling:"greedy",streetViewControl:!1,minZoom:4,maxZoom:20}),s=(e=>{const t=document.createElement("button");return t.className="ms-sf-btn sf-icon-zoom ",t.ariaLabel="Zoom In",t.addEventListener("click",()=>{if(!e)return;const t=e.getZoom()+1;e.setZoom(t)}),t})(a),o=(e=>{const t=document.createElement("button");return t.className="ms-sf-btn sf-icon-min ",t.ariaLabel="Zoom Out",t.addEventListener("click",()=>{if(!e)return;const t=e.getZoom()-1;e.setZoom(t)}),t})(a),r=(e=>{const t=document.createElement("button");return t.className="ms-sf-btn sf-icon-satellite",t.ariaLabel="Satellite View",t.addEventListener("click",()=>{const n=["roadmap","satellite"];let a=0;if(n.forEach((t,n)=>{t===e.getMapTypeId()&&(a=n)}),e.setMapTypeId(n[1===a?0:a+1]),1===a)return t.classList.remove("sf-icon-guide"),void t.classList.add("sf-icon-satellite");t.classList.remove("sf-icon-satellite"),t.classList.add("sf-icon-guide")}),t})(a),i=((e,t,n)=>{const s=document.createElement("button");return s.className="ms-sf-btn sf-icon-draw ms-sf-draw-control",s.ariaLabel="Draw Area",n&&(s.style.display="none"),s.addEventListener("click",()=>{u("on"),(()=>{if(!a)return;Oe(a);const e=google.maps.event.addDomListenerOnce(a.getDiv(),"touchstart",()=>Pe(a)),t=google.maps.event.addDomListenerOnce(a.getDiv(),"mousedown",()=>Pe(a));ze(e),De(t)})?.()}),s})(0,0,"edit"===O),l=(e=>{const t=document.createElement("button");return t.className="ms-sf-btn sf-icon-location",t.ariaLabel="Location",t.addEventListener("click",async()=>{const{findCurrentLocation:t}=await q(()=>import("./mapOperations-DZWFYxTu.js"),__vite__mapDeps([]),import.meta.url);t(e)}),t})(a),c=document.createElement("div");c.className="ms-sf-item",c.appendChild(s),c.appendChild(o),c.appendChild(i),c.appendChild(r),c.appendChild(l);const m=document.createElement("div");if(m.className="ms-sf-wrapper-map-actions",m.appendChild(c),a.controls[google.maps.ControlPosition.TOP_RIGHT].push(m),!e&&ye.polygon){const e=ye.polygon.split(",").map(e=>g(e)).flatMap(e=>{const t=[];return e.forEach(e=>t.push({lat:e.lat(),lng:e.lng()})),t});U(e,a)}ne(z(a))};e.useEffect(()=>{if(!le||"map"!==ve||!O)return;const e=e=>{const t="new"===O||!!Ce;e.style.display=t?"flex":"none",t||(Be(),u("off"))},t=()=>le.getDiv().querySelector(".ms-sf-draw-control");let n=t();if(n)return void e(n);const a=le.addListener("idle",()=>{n=t(),n&&(e(n),a.remove(),o?.disconnect())}),s=le.getDiv(),o=new MutationObserver(()=>{n=t(),n&&(e(n),a.remove?.(),o.disconnect())});return o.observe(s,{childList:!0,subtree:!0}),()=>{a.remove?.(),o.disconnect()}},[le,ve,Ce]),e.useEffect(()=>{je||le||We()},[je,le]),e.useEffect(()=>{if(!le)return;const e=()=>{Se()},t=e=>{const t=e,{coords:n}=t.detail;Ae(le,...n)},n=e=>{const t=e,{skipFilterUpdate:n}=t.detail||{};Te(le,n)},a=e=>{const t=e,{paths:n}=t.detail,a=n.map(e=>Ie(e,le));ne(Z({initial:!0,data:a}))},s=e=>{const t=e,{points:n}=t.detail;U(n,le)},o=e=>{const t=e,{rect:n,zm:a}=t.detail;G({rect:n,zm:a},le)};return window.addEventListener("map:clearPolygons",e),window.addEventListener("map:drawPolygons",t),window.addEventListener("map:clearFreeHand",n),window.addEventListener("map:paintFreeHand",a),window.addEventListener("map:centerByPoints",s),window.addEventListener("map:centerByRect",o),()=>{window.removeEventListener("map:clearPolygons",e),window.removeEventListener("map:drawPolygons",t),window.removeEventListener("map:clearFreeHand",n),window.removeEventListener("map:paintFreeHand",a),window.removeEventListener("map:centerByPoints",s),window.removeEventListener("map:centerByRect",o)}},[le,Se,Ae,_e,Ie,ne]);const qe=e.useMemo(()=>l(K),[K]);return e.useEffect(()=>{if(!le)return;const e=le.addListener("click",()=>c());return()=>e.remove()},[le]),e.useEffect(()=>{if(!le)return;let e=!1;return(async()=>{const{AdvancedMarkerElement:t}=await google.maps.importLibrary("marker");let n=ce;if(!n||$e.current!==ge){if(n&&(n.clearMarkers?.(!0),n.setMap(null)),n=await(async({markers:e,map:t,markerGrouping:n=!1})=>{const{AdvancedMarkerElement:s}=await google.maps.importLibrary("marker"),{MarkerClusterer:o,SuperClusterAlgorithm:r}=await a(),i=new o({markers:e,map:t,algorithm:new r({maxZoom:n&&14,radius:120}),renderer:{render:({markers:e,position:t})=>(({amount:e,position:t,AdvancedMarkerElement:n})=>{const a=document.createElement("div");a.className="MarkerClustererElement";const s=Math.min(e+26,50);return a.style.height=s+10+"px",a.style.width=s+10+"px",a.innerHTML=`\n    <div \n      style="width: ${s}px; height: ${s}px;"\n    >\n      ${e}\n    </div>\n    `,new n({position:t,content:a})})({position:t,amount:e?.length||0,AdvancedMarkerElement:s})}});return i})({markers:[],map:le,markerGrouping:ge}),$e.current=ge,e)return;ne(_(n))}const r=qe.map(e=>function({properties:e,AdvancedMarkerElement:t,handleClick:n,favoriteIcon:a,favoriteCTA:r,shareCTA:i,t:l,attachToMap:c=!1,map:m}){const d=e[0],p=`${d.lat},${d.lng}`,u=document.createElement("div");if(u.className="ms-sf-richmarker",u.id=p,u.title=e.map(({mls_num:e})=>e).join(","),e.length>1)u.innerHTML=`<span class="ms-sf-price">${e.length} ${l("Units")}</span>`;else{const e=2===d.mls_status?d.price_sold||0:d.price,t=null===d?.reduced_price||isNaN(d?.reduced_price)?0:d?.reduced_price;u.innerHTML=`\n      <span class="ms-sf-price">\n        ${s.format(e)}\n        ${t?`<i class="sf-icon-arrow-back ${t<0?"-down":"-up"}"></i>`:""}\n      </span>`}const g=new t({position:{lat:Number(d.lat),lng:Number(d.lng)},content:u,...c&&m?{map:m}:{}});return g.addListener("click",()=>o({properties:e,favoriteIcon:a,favoriteCTA:r,shareCTA:i,handleClick:n,t:l})),g}({properties:e,AdvancedMarkerElement:t,handleClick:Fe,favoriteIcon:he,favoriteCTA:ie,shareCTA:Ve,t:te,attachToMap:!1})),i=(e=>e.filter(e=>!!e.position))(r);if("function"==typeof n.setMarkers)n.setMarkers(i);else if(n.clearMarkers?.(!0),i.length>0){n.addMarkers?.(i,!0);const e=()=>{Y(le)&&i.length>0&&n.render()};Y(le)?e():google.maps.event.addListenerOnce(le,"idle",e)}else Y(le)&&n.render();oe(!0)})(),()=>{e=!0}},[le,qe,ge]),e.useEffect(()=>{ce&&(se||Me)&&((ce?.markers||[]).forEach(e=>{const t=e.targetElement,n=I(t);if(!n)return;const a=n.split(",");if(!(a.length>1)){const e=a.some(e=>!!Me[e]);T(t,he,e)}a.forEach(e=>{A(e,!!Me[e])}),t.onclick=()=>{a.forEach(e=>{A(e,!!Me[e])})}}),oe(!1))},[Me,he,ce,se]),e.useEffect(()=>{!le||K.length||!ye.keyword_main||ye.rect||Le.rect||ye.zm||Le.zm||!Object.entries(we).length||(le.setCenter(X(`${we.rect}`)),le.setZoom(Number(we.zm)))},[le,K,ye,we]),e.useEffect(()=>{let e;return le&&(e=le.addListener("bounds_changed",Re)),()=>{e?.remove()}},[le,ne,Re]),e.useEffect(()=>{setTimeout(()=>{const e=S("all"),t=window.innerHeight-e,n=document.querySelector("#map"),a=document.querySelector(".ms-sf-filter-map");n.style.transition="height 0.2s ease, top 0.2s ease",n.style.height=`${t||0}px`,n.style.top=`${e}px`,a.style.transition="height 0.2s ease, top 0.2s ease",a.style.height=`${t||0}px`,a.style.top=`${e}px`},400)},[ae,xe]),e.useEffect(()=>{if(!le?.get("mapId"))return;if(me.data.length<=1)return;let e=!1;return(async()=>{const{cleanCoords:t,multiPoint:n,polygon:a,featureCollection:s,union:o,unkink:r}=await m();if(e)return;const i=me.data.map(e=>t(n(e.getPath().getArray().map(e=>[e.lat(),e.lng()]))).geometry.coordinates).filter(e=>e.length>=4).map(e=>e.map(e=>new google.maps.LatLng(e[0],e[1]))).map(e=>r(e)).flatMap(e=>e.features.map(e=>e.geometry.coordinates[0])).filter(e=>e.length>=4);if(e)return;if(i.length<2)return void Be();const l=e=>{if(!e.length)return e;const[t,n]=e[0],[a,s]=e[e.length-1];return t===a&&n===s?e:[...e,[t,n]]},c=o(s(i.map(e=>a([l(e)]))));if(c){if(me.data.forEach(e=>e.setMap(null)),"Polygon"===c.geometry.type){const e=Ie(c.geometry.coordinates[0].map(e=>new google.maps.LatLng(e[1],e[0])),le);ne(Z({initial:!1,data:[e]}))}if("MultiPolygon"===c.geometry.type){const e=[];c.geometry.coordinates.forEach(t=>{const n=t[0],a=Ie(n.map(e=>new google.maps.LatLng(e[1],e[0])),le);e.push(a)}),ne(Z({initial:!1,data:e}))}}})(),()=>{e=!0}},[me.data.length,le?.get("mapId")]),t.jsxs("div",{id:"map-container",className:`ms-sf-filter-map ${je?"-loading":""} `,children:[!ee&&ke>fe&&!ge&&t.jsxs("div",{className:"ms-sf-markers-count-alert",children:[t.jsx("span",{children:`${te("Showing")} ${K.length} ${te("of")} ${ke?.toLocaleString("en")||0} ${te("properties")}.`}),t.jsx("span",{children:te("Zoom in to see more.")})]}),t.jsxs("div",{className:"ms-sf-wrapper-draw-map-header",children:[t.jsx("span",{children:te("Draw a shape around the region(s) you would like to live in")}),t.jsx("div",{className:"ms-sf-flex",children:t.jsx("button",{className:"ms-sf-btn -cancel",onClick:Be,children:te("Cancel")})})]}),t.jsx("div",{ref:re,id:"property-info-box"}),t.jsx("div",{className:"ms-sf-map-loading-layout",children:t.jsx("div",{className:"sf-icon-map"})}),t.jsx("div",{id:"map",className:"ms-sf-filter-map"})]})};export{K as default};
function __vite__mapDeps(indexes) {
  if (!__vite__mapDeps.viteFileDeps) {
    __vite__mapDeps.viteFileDeps = []
  }
  return indexes.map((i) => __vite__mapDeps.viteFileDeps[i])
}
