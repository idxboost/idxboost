import{r as l,F as m}from"./vendor-B1il49z_.js";import{b as ye}from"./state-MsRYJGzt.js";import{ae as Ce,af as ke,ag as Me,ah as ve,ai as we,aj as Le,ak as Pe,al as xe,am as Ee,an as b,s as be,w as Se,ao as De,ap as Ie,aq as je,ar as Q,g as X,as as Fe,at as Oe,au as Y,av as ee,c as Ae,b as Be,d as Ne,h as Te,f as ze,l as He,j as Re,aw as Ze,v as $e,ax as qe,ay as _e,az as Ve,aA as Ue,aB as Ge,aC as We,aD as Je,aE as Ke,aF as Qe}from"./index-C7PaGv0p.js";import{P as Xe,a as Ye}from"./PropertyMarkerElement-DWdqjnfb.js";import{u as et}from"./i18n-Cmvy_zuU.js";import"./gmaps-BDODJA70.js";const te=p=>!!p?.getBounds()&&!!p?.getProjection(),tt=p=>p.filter(S=>!!S.position),lt=({data:p=[],isLoading:S=!1})=>{const{t:y}=et(),d=ye(),{width:oe}=Ce(),[B,N]=l.useState(!1),T=l.useRef(null);function se(t){const r=document.querySelector(".ms-sf-wrapper-sorter"),e=document.querySelector("#shareModal");if(r&&r.contains(t.target)||e&&e.contains(t.target))return;const o=document.getElementById("property-info-box");if(o){const a=o.getAttribute("data-position");a&&$e(a)}}ke(T,se);const[ne]=Me(),{map:s,markerClusterer:w,freeHandPolygons:L}=ve(),{currentLat:re,currentLng:ae,zoom:ie,clusterMarkersActive:k,maxNumberMarkers:le,favoriteIcon:D}=we(),{viewOption:I,filters:u,tempFilters:P,isFirstCenter:ce,searchRunning:ue,count:z,defaultLocation:H,favorites:M}=Le(),{editingCriteria:j,selectedEditCategoryId:me}=Pe(),F=!u.rect&&!u.polygon&&!u.keyword_main,R=l.useRef(!0),Z=l.useRef(k),{draw:$,disable:de,enable:pe,paint:q}=xe(),[_,V]=l.useState(null),[U,G]=l.useState(null);function fe(t){qe({mlsNumber:t.mls_num,isSold:t.mls_status===2})}const W=Ee(()=>{const t=s?.getCenter(),r=t?.lat(),e=t?.lng(),o=s?.getZoom();if(!(I!=="map"||b==="edit"&&!j)){if(re!==r||ae!==e||ie!==o)d(_e(r)),d(Ve(e)),d(Ue(o));else return;if(R.current){R.current=!1;return}if(ue){d(Ge(!1));return}if(ce){d(We(!1));return}u.polygon||u.keyword_main||d(Je({rect:s?.getBounds()?.toUrlValue(),zm:s?.getZoom()?.toString()}))}},700),O=()=>{s&&(_&&(google.maps.event.removeListener(_),V(null)),U&&(google.maps.event.removeListener(U),G(null)),pe(s,!0),ee("off"))};function ge(t){const r=Ke(t,y);Qe(r)}const he=async()=>{const t=u.rect||H.rect,r=t?X(t):void 0,e=Number(u.zm||H.zm),o=new google.maps.Map(document.getElementById("map"),{center:r,zoom:e,mapId:"m4p1D",zoomControl:!1,mapTypeControl:!1,scaleControl:!1,rotateControl:!1,fullscreenControl:!1,clickableIcons:!1,panControl:!1,gestureHandling:"greedy",streetViewControl:!1,minZoom:4,maxZoom:20}),a=Ae(o),f=Be(o),i=Ne(o),C=Te(o,()=>{if(!o)return;de(o);const h=google.maps.event.addDomListenerOnce(o.getDiv(),"touchstart",()=>$(o)),n=google.maps.event.addDomListenerOnce(o.getDiv(),"mousedown",()=>$(o));V(h),G(n)},b==="edit"),K=ze(o),g=document.createElement("div");g.className="ms-sf-item",g.appendChild(a),g.appendChild(f),g.appendChild(C),g.appendChild(i),g.appendChild(K);const v=document.createElement("div");if(v.className="ms-sf-wrapper-map-actions",v.appendChild(g),o.controls[google.maps.ControlPosition.TOP_RIGHT].push(v),!t&&u.polygon){const h=He(u.polygon);Re(h,o)}d(Ze(o))};l.useEffect(()=>{if(!s||I!=="map"||!b)return;const t=i=>{const C=b==="new"||!!j;i.style.display=C?"flex":"none",C||(O(),ee("off"))},r=()=>s.getDiv().querySelector(".ms-sf-draw-control");let e=r();if(e){t(e);return}const o=s.addListener("idle",()=>{e=r(),e&&(t(e),o.remove(),f?.disconnect())}),a=s.getDiv(),f=new MutationObserver(()=>{e=r(),e&&(t(e),o.remove?.(),f.disconnect())});return f.observe(a,{childList:!0,subtree:!0}),()=>{o.remove?.(),f.disconnect()}},[s,I,j]),l.useEffect(()=>{F||s||he()},[F,s]);const J=l.useMemo(()=>be(p),[p]);return l.useEffect(()=>{if(!s)return;const t=s.addListener("click",()=>Se());return()=>t.remove()},[s]),l.useEffect(()=>{if(!s)return;let t=!1;return(async()=>{const{AdvancedMarkerElement:r}=await google.maps.importLibrary("marker");let e=w;if(!e||Z.current!==k){if(e&&(e.clearMarkers?.(!0),e.setMap(null)),e=await Xe({markers:[],map:s,markerGrouping:k}),Z.current=k,t)return;d(De(e))}const o=J.map(i=>Ye({properties:i,AdvancedMarkerElement:r,handleClick:fe,favoriteIcon:D,favoriteCTA:ne,shareCTA:ge,t:y,attachToMap:!1})),a=tt(o);if(typeof e.setMarkers=="function")e.setMarkers(a);else if(e.clearMarkers?.(!0),a.length>0){e.addMarkers?.(a,!0);const i=()=>{te(s)&&a.length>0&&e.render()};te(s)?i():google.maps.event.addListenerOnce(s,"idle",i)}N(!0)})(),()=>{t=!0}},[s,J,k]),l.useEffect(()=>{w&&(B||M)&&((w?.markers||[]).forEach(r=>{const e=r.targetElement,o=Ie(e);if(!o)return;const a=o.split(",");if(!(a.length>1)){const i=a.some(C=>!!M[C]);je(e,D,i)}a.forEach(i=>{Q(i,!!M[i])}),e.onclick=()=>{a.forEach(i=>{Q(i,!!M[i])})}}),N(!1))},[M,D,w,B]),l.useEffect(()=>{s&&!p.length&&u.keyword_main&&!u.rect&&!u.zm&&Object.entries(P).length&&(s.setCenter(X(`${P.rect}`)),s.setZoom(Number(P.zm)))},[s,p,u,P]),l.useEffect(()=>{let t;return s&&(t=s.addListener("bounds_changed",W)),()=>{t?.remove()}},[s,d,W]),l.useEffect(()=>{setTimeout(()=>{const t=Fe("all"),r=window.innerHeight-t,e=document.querySelector("#map"),o=document.querySelector(".ms-sf-filter-map");e.style.transition="height 0.2s ease, top 0.2s ease",e.style.height=`${r||0}px`,e.style.top=`${t}px`,o.style.transition="height 0.2s ease, top 0.2s ease",o.style.height=`${r||0}px`,o.style.top=`${t}px`},400)},[oe,me]),l.useEffect(()=>{if(!s?.get("mapId")||L.data.length<=1)return;let t=!1;return(async()=>{const{cleanCoords:r,multiPoint:e,polygon:o,featureCollection:a,union:f,unkink:i}=await Oe();if(t)return;const g=L.data.map(n=>r(e(n.getPath().getArray().map(c=>[c.lat(),c.lng()]))).geometry.coordinates).filter(n=>n.length>=4).map(n=>n.map(c=>new google.maps.LatLng(c[0],c[1]))).map(n=>i(n)).flatMap(n=>n.features.map(c=>c.geometry.coordinates[0])).filter(n=>n.length>=4);if(t)return;if(g.length<2){console.log("Incorrect area defined. Adjust region outline to see the result"),O();return}const v=n=>{if(!n.length)return n;const[c,x]=n[0],[A,E]=n[n.length-1];return c===A&&x===E?n:[...n,[c,x]]},h=f(a(g.map(n=>o([v(n)]))));if(h){if(L.data.forEach(n=>n.setMap(null)),h.geometry.type==="Polygon"){const n=q(h.geometry.coordinates[0].map(c=>new google.maps.LatLng(c[1],c[0])),s);d(Y({initial:!1,data:[n]}))}if(h.geometry.type==="MultiPolygon"){const n=[];h.geometry.coordinates.forEach(c=>{const x=c[0],A=q(x.map(E=>new google.maps.LatLng(E[1],E[0])),s);n.push(A)}),d(Y({initial:!1,data:n}))}}})(),()=>{t=!0}},[L.data.length,s?.get("mapId")]),m.jsxs("div",{id:"map-container",className:`ms-sf-filter-map ${F?"-loading":""} `,children:[!S&&z>le&&!k&&m.jsxs("div",{className:"ms-sf-markers-count-alert",children:[m.jsx("span",{children:`${y("Showing")} ${p.length} ${y("of")} ${z?.toLocaleString("en")||0} ${y("properties")}.`}),m.jsx("span",{children:y("Zoom in to see more.")})]}),m.jsxs("div",{className:"ms-sf-wrapper-draw-map-header",children:[m.jsx("span",{children:y("Draw a shape around the region(s) you would like to live in")}),m.jsx("div",{className:"ms-sf-flex",children:m.jsx("button",{className:"ms-sf-btn -cancel",onClick:O,children:y("Cancel")})})]}),m.jsx("div",{ref:T,id:"property-info-box"}),m.jsx("div",{className:"ms-sf-map-loading-layout",children:m.jsx("div",{className:"sf-icon-map"})}),m.jsx("div",{id:"map",className:"ms-sf-filter-map"})]})};export{lt as default};
