import{r as e,j as t}from"./react-vendor-CnO_ZB-6.js";import{b as a}from"./state-DbALYLXJ.js";import{f as n,U as s,g as o,u as r,d as i,h as l,i as c,j as m,k as d,m as p}from"./index-vnb_dlQJ.js";import{aN as u,aO as g,b as f,a as h,aP as v,aQ as y,g as w,aR as b,aS as E,aT as k,aU as L,aV as M,aW as C,aX as x,aY as j,aG as N,i as $,a8 as P,E as O,aZ as _,a_ as I,a$ as T,b0 as A,ax as S,b1 as Z,b2 as H,aI as z,b3 as D,b4 as F,b5 as R,e as B,b6 as V,aJ as W}from"./index-CMXH3I_2.js";import{_ as q}from"./vendor-CMABA041.js";import"./utils-Cg5OwTVl.js";import{centerMapByPoints as U,centerMapByRect as G}from"./mapOperations-DZWFYxTu.js";import{u as J}from"./useOutsideClick-CdiqAPpl.js";import{u as Q}from"./i18n-TlBH8u-u.js";const X=e=>{const t=e.split(","),a=parseFloat(t[0]),n=parseFloat(t[1]);return{lat:(a+parseFloat(t[2]))/2,lng:(n+parseFloat(t[3]))/2}},Y=e=>!!e?.getBounds()&&!!e?.getProjection(),K=({data:K=[],isLoading:ee=!1})=>{const{t:te}=Q(),ae=a(),{width:ne}=r(),[se,oe]=e.useState(!1),re=e.useRef(null);J(re,function(e){const t=document.querySelector(".ms-sf-wrapper-sorter"),a=document.querySelector("#shareModal");if(t&&t.contains(e.target)||a&&a.contains(e.target))return;const n=document.getElementById("property-info-box");if(n){const e=n.getAttribute("data-position");e&&d(e)}});const[ie]=N(),{map:le,markerClusterer:ce,freeHandPolygons:me}=f(),{currentLat:de,currentLng:pe,zoom:ue,clusterMarkersActive:ge,maxNumberMarkers:fe,favoriteIcon:he}=$(),{viewOption:ve,filters:ye,tempFilters:we,isFirstCenter:be,searchRunning:Ee,count:ke,defaultLocation:Le,favorites:Me}=h(),{editingCriteria:Ce,selectedEditCategoryId:xe}=P(),je=!(ye.rect||Le.rect||ye.polygon||ye.keyword_main),Ne=e.useRef(!0),$e=e.useRef(ge),{draw:Pe,disable:Oe,enable:_e,paint:Ie,clear:Te}=(()=>{const t=a(),[n,s]=e.useState(""),{freeHandPolygons:o}=f(),{loading:r}=h(),i=e.useRef(null);e.useEffect(()=>{const e=v("--ibc--idx-primary-color");s(e)},[]),e.useEffect(()=>{if(o.data.length&&!r){const e=o.data.map(e=>y(e)).join(",");o.initial||t(w({polygon:e,rect:void 0,zm:void 0,keyword_main:void 0}))}},[o,t,r]);const l=e.useCallback((e,t)=>{const a=t.getZoom()||15,s=[];e.forEach(e=>s.push({lat:e.lat(),lng:e.lng()}));const o=((e,t)=>{let a,n,s,o,r,i,l,c,m,d,p,u,g,f,h,v,y,w,b=0;const E=Math.PI/180*.5,k=[],L=[],M=[];if(e.length<3)return e;for(b=e.length,m=360*t/(2*Math.PI*6378137),m*=m,n=0,L[0]=0,M[0]=b-1,a=1;a>0;)if(s=L[a-1],o=M[a-1],a--,o-s>1){for(d=e[o].lng-e[s].lng,p=e[o].lat-e[s].lat,Math.abs(d)>180&&(d=360-Math.abs(d)),d*=Math.cos(E*(e[o].lat+e[s].lat)),u=d*d+p*p,r=s+1,i=s,c=-1;r<o;r++)g=e[r].lng-e[s].lng,f=e[r].lat-e[s].lat,Math.abs(g)>180&&(g=360-Math.abs(g)),g*=Math.cos(E*(e[r].lat+e[s].lat)),h=g*g+f*f,v=e[r].lng-e[o].lng,y=e[r].lat-e[o].lat,Math.abs(v)>180&&(v=360-Math.abs(v)),v*=Math.cos(E*(e[r].lat+e[o].lat)),w=v*v+y*y,l=h>=u+w?w:w>=u+h?h:(g*p-f*d)*(g*p-f*d)/u,l>c&&(i=r,c=l);c<m?(k[n]=s,n++):(a++,L[a-1]=i,M[a-1]=o,a++,L[a-1]=s,M[a-1]=i)}else k[n]=s,n++;k[n]=b-1,n++;const C=[];for(let x=0;x<n;x++)C.push(e[k[x]]);return C})(s,20-a/20*19);return new google.maps.Polygon({map:t,paths:o,strokeColor:n,strokeOpacity:.8,strokeWeight:2,fillColor:n,fillOpacity:.2,clickable:!1})},[n]),c=e.useCallback((e,a)=>{if(o.data.forEach(e=>{e.setMap(null)}),t(b()),!a){if(e){const a=e.getCenter()?.lat()||0,n=e.getCenter()?.lng()||0,s=`${e.getZoom()||11}`,o=((e,t)=>{const a=document.getElementById("map"),n=a?.offsetWidth||window.innerWidth,s=a?.offsetHeight||window.innerHeight,o=Math.pow(2,t),r=180/(256*o)*s*1.8/2,i=360/(256*o)*n/2;return`${e.lat-r},${e.lng-i},${e.lat+r},${e.lng+i}`})({lat:a,lng:n},Number(s));t(w({rect:o,zm:s}))}t(w({polygon:void 0,keyword_main:void 0}))}},[o,t]),m=(e,a)=>{t(k(!1)),e.setOptions({draggable:!0}),i.current&&i.current.disconnect(),a&&(t(M(!0)),C())};return{draw:e=>{const a=e=>e.preventDefault();document.body.addEventListener("touchmove",a,{passive:!1});let s=new google.maps.Polyline({map:e,clickable:!1,strokeColor:n,strokeOpacity:.8,strokeWeight:2});const o=google.maps.event.addListener(e,"mousemove",function(e){s.getPath().push(e.latLng)});google.maps.event.addListenerOnce(e,"mouseup",function(){google.maps.event.removeListener(o);const n=s.getPath(),r=n.getLength()>1;r&&(s.setMap(null),s=l(n,e),t(E(s))),google.maps.event.clearListeners(e.getDiv(),"mousedown"),google.maps.event.clearListeners(e.getDiv(),"touchstart"),m(e,!r),document.body.removeEventListener("touchmove",a),u("off")})},paint:l,disable:e=>{t(k(!0)),e.setOptions({draggable:!1}),L(),t(M(!1));const a=new MutationObserver(()=>L());a.observe(document.body,{childList:!0,subtree:!0}),i.current=a},enable:m,clear:c}})(),{draw:Ae,clear:Se}=(()=>{const t=a(),{polygons:n,polygonVisibility:s}=f(),[o,r]=e.useState("");return e.useEffect(()=>{n.forEach(e=>e.setVisible(s))},[n,s]),e.useEffect(()=>{const e=v("--ibc--idx-primary-color");r(e)},[]),{draw:(e,...a)=>{e&&a.forEach(a=>{const n=new google.maps.Polygon({paths:a,strokeColor:o,strokeOpacity:.8,strokeWeight:2,fillColor:o,fillOpacity:.2});t(j(n)),n.setMap(e)})},clear:e.useCallback(()=>{n.forEach(e=>{e.setMap(null)}),t(x()),t(M(!0))},[n,t])}})(),[Ze,He]=e.useState(null),[ze,De]=e.useState(null);function Fe(e){z({mlsNumber:e.mls_num,isSold:2===e.mls_status})}const Re=i(()=>{const e=le?.getCenter(),t=e?.lat(),a=e?.lng(),n=le?.getZoom();"map"!==ve||"edit"===O&&!Ce||de===t&&pe===a&&ue===n||(ae(D(t)),ae(F(a)),ae(R(n)),Ne.current?Ne.current=!1:Ee?ae(B(!1)):be?ae(V(!1)):ye.polygon||ye.keyword_main||ae(w({rect:le?.getBounds()?.toUrlValue(),zm:le?.getZoom()?.toString()})))},700),Be=()=>{le&&(Ze&&(google.maps.event.removeListener(Ze),He(null)),ze&&(google.maps.event.removeListener(ze),De(null)),_e(le,!0),u("off"))};function Ve(e){const t=p(e,te);W(t)}const We=async()=>{const e=ye.rect||Le.rect,t=e?X(e):void 0,a=Number(ye.zm||Le.zm),n=new google.maps.Map(document.getElementById("map"),{center:t,zoom:a,mapId:"m4p1D",zoomControl:!1,mapTypeControl:!1,scaleControl:!1,rotateControl:!1,fullscreenControl:!1,clickableIcons:!1,panControl:!1,gestureHandling:"greedy",streetViewControl:!1,minZoom:4,maxZoom:20}),s=(e=>{const t=document.createElement("button");return t.className="ms-sf-btn sf-icon-zoom ",t.ariaLabel="Zoom In",t.addEventListener("click",()=>{if(!e)return;const t=e.getZoom()+1;e.setZoom(t)}),t})(n),o=(e=>{const t=document.createElement("button");return t.className="ms-sf-btn sf-icon-min ",t.ariaLabel="Zoom Out",t.addEventListener("click",()=>{if(!e)return;const t=e.getZoom()-1;e.setZoom(t)}),t})(n),r=(e=>{const t=document.createElement("button");return t.className="ms-sf-btn sf-icon-satellite",t.ariaLabel="Satellite View",t.addEventListener("click",()=>{const a=["roadmap","satellite"];let n=0;if(a.forEach((t,a)=>{t===e.getMapTypeId()&&(n=a)}),e.setMapTypeId(a[1===n?0:n+1]),1===n)return t.classList.remove("sf-icon-guide"),void t.classList.add("sf-icon-satellite");t.classList.remove("sf-icon-satellite"),t.classList.add("sf-icon-guide")}),t})(n),i=((e,t,a)=>{const s=document.createElement("button");return s.className="ms-sf-btn sf-icon-draw ms-sf-draw-control",s.ariaLabel="Draw Area",a&&(s.style.display="none"),s.addEventListener("click",()=>{u("on"),(()=>{if(!n)return;Oe(n);const e=google.maps.event.addDomListenerOnce(n.getDiv(),"touchstart",()=>Pe(n)),t=google.maps.event.addDomListenerOnce(n.getDiv(),"mousedown",()=>Pe(n));He(e),De(t)})?.()}),s})(0,0,"edit"===O),l=(e=>{const t=document.createElement("button");return t.className="ms-sf-btn sf-icon-location",t.ariaLabel="Location",t.addEventListener("click",async()=>{const{findCurrentLocation:t}=await q(()=>import("./mapOperations-DZWFYxTu.js"),__vite__mapDeps([]),import.meta.url);t(e)}),t})(n),c=document.createElement("div");c.className="ms-sf-item",c.appendChild(s),c.appendChild(o),c.appendChild(i),c.appendChild(r),c.appendChild(l);const m=document.createElement("div");if(m.className="ms-sf-wrapper-map-actions",m.appendChild(c),n.controls[google.maps.ControlPosition.TOP_RIGHT].push(m),!e&&ye.polygon){const e=ye.polygon.split(",").map(e=>g(e)).flatMap(e=>{const t=[];return e.forEach(e=>t.push({lat:e.lat(),lng:e.lng()})),t});U(e,n)}ae(H(n))};e.useEffect(()=>{if(!le||"map"!==ve||!O)return;const e=e=>{const t="new"===O||!!Ce;e.style.display=t?"flex":"none",t||(Be(),u("off"))},t=()=>le.getDiv().querySelector(".ms-sf-draw-control");let a=t();if(a)return void e(a);const n=le.addListener("idle",()=>{a=t(),a&&(e(a),n.remove(),o?.disconnect())}),s=le.getDiv(),o=new MutationObserver(()=>{a=t(),a&&(e(a),n.remove?.(),o.disconnect())});return o.observe(s,{childList:!0,subtree:!0}),()=>{n.remove?.(),o.disconnect()}},[le,ve,Ce]),e.useEffect(()=>{je||le||We()},[je,le]),e.useEffect(()=>{if(!le)return;const e=()=>{Se()},t=e=>{const t=e,{coords:a}=t.detail;Ae(le,...a)},a=e=>{const t=e,{skipFilterUpdate:a}=t.detail||{};Te(le,a)},n=e=>{const t=e,{paths:a,shouldHide:n}=t.detail,s=a.map(e=>Ie(e,le));n&&s.forEach(e=>e.setVisible(!1)),ae(Z({initial:!0,data:s}))},s=e=>{const t=e,{points:a}=t.detail;U(a,le)},o=e=>{const t=e,{rect:a,zm:n}=t.detail;G({rect:a,zm:n},le)};return window.addEventListener("map:clearPolygons",e),window.addEventListener("map:drawPolygons",t),window.addEventListener("map:clearFreeHand",a),window.addEventListener("map:paintFreeHand",n),window.addEventListener("map:centerByPoints",s),window.addEventListener("map:centerByRect",o),()=>{window.removeEventListener("map:clearPolygons",e),window.removeEventListener("map:drawPolygons",t),window.removeEventListener("map:clearFreeHand",a),window.removeEventListener("map:paintFreeHand",n),window.removeEventListener("map:centerByPoints",s),window.removeEventListener("map:centerByRect",o)}},[le,Se,Ae,_e,Ie,ae]);const qe=e.useMemo(()=>l(K),[K]);return e.useEffect(()=>{if(!le)return;const e=le.addListener("click",()=>c());return()=>e.remove()},[le]),e.useEffect(()=>{if(!le)return;let e=!1;return(async()=>{const{AdvancedMarkerElement:t}=await google.maps.importLibrary("marker");let a=ce;if(!a||$e.current!==ge){if(a&&(a.clearMarkers?.(!0),a.setMap(null)),a=await(async({markers:e,map:t,markerGrouping:a=!1})=>{const{AdvancedMarkerElement:s}=await google.maps.importLibrary("marker"),{MarkerClusterer:o,SuperClusterAlgorithm:r}=await n(),i=new o({markers:e,map:t,algorithm:new r({maxZoom:a&&14,radius:120}),renderer:{render:({markers:e,position:t})=>(({amount:e,position:t,AdvancedMarkerElement:a})=>{const n=document.createElement("div");n.className="MarkerClustererElement";const s=Math.min(e+26,50);return n.style.height=s+10+"px",n.style.width=s+10+"px",n.innerHTML=`\n    <div \n      style="width: ${s}px; height: ${s}px;"\n    >\n      ${e}\n    </div>\n    `,new a({position:t,content:n})})({position:t,amount:e?.length||0,AdvancedMarkerElement:s})}});return i})({markers:[],map:le,markerGrouping:ge}),$e.current=ge,e)return;ae(_(a))}const r=qe.map(e=>function({properties:e,AdvancedMarkerElement:t,handleClick:a,favoriteIcon:n,favoriteCTA:r,shareCTA:i,t:l,attachToMap:c=!1,map:m}){const d=e[0],p=`${d.lat},${d.lng}`,u=document.createElement("div");if(u.className="ms-sf-richmarker",u.id=p,u.title=e.map(({mls_num:e})=>e).join(","),e.length>1)u.innerHTML=`<span class="ms-sf-price">${e.length} ${l("Units")}</span>`;else{const e=2===d.mls_status?d.price_sold||0:d.price,t=null===d?.reduced_price||isNaN(d?.reduced_price)?0:d?.reduced_price;u.innerHTML=`\n      <span class="ms-sf-price">\n        ${s.format(e)}\n        ${t?`<i class="sf-icon-arrow-back ${t<0?"-down":"-up"}"></i>`:""}\n      </span>`}const g=new t({position:{lat:Number(d.lat),lng:Number(d.lng)},content:u,...c&&m?{map:m}:{}});return g.addListener("click",()=>o({properties:e,favoriteIcon:n,favoriteCTA:r,shareCTA:i,handleClick:a,t:l})),g}({properties:e,AdvancedMarkerElement:t,handleClick:Fe,favoriteIcon:he,favoriteCTA:ie,shareCTA:Ve,t:te,attachToMap:!1})),i=(e=>e.filter(e=>!!e.position))(r);if("function"==typeof a.setMarkers)a.setMarkers(i);else if(a.clearMarkers?.(!0),i.length>0){a.addMarkers?.(i,!0);const e=()=>{Y(le)&&i.length>0&&a.render()};Y(le)?e():google.maps.event.addListenerOnce(le,"idle",e)}else Y(le)&&a.render();oe(!0)})(),()=>{e=!0}},[le,qe,ge]),e.useEffect(()=>{ce&&(se||Me)&&((ce?.markers||[]).forEach(e=>{const t=e.targetElement,a=I(t);if(!a)return;const n=a.split(",");if(!(n.length>1)){const e=n.some(e=>!!Me[e]);T(t,he,e)}n.forEach(e=>{A(e,!!Me[e])}),t.onclick=()=>{n.forEach(e=>{A(e,!!Me[e])})}}),oe(!1))},[Me,he,ce,se]),e.useEffect(()=>{!le||K.length||!ye.keyword_main||ye.rect||Le.rect||ye.zm||Le.zm||!Object.entries(we).length||(le.setCenter(X(`${we.rect}`)),le.setZoom(Number(we.zm)))},[le,K,ye,we]),e.useEffect(()=>{let e;return le&&(e=le.addListener("bounds_changed",Re)),()=>{e?.remove()}},[le,ae,Re]),e.useEffect(()=>{setTimeout(()=>{const e=S("all"),t=window.innerHeight-e,a=document.querySelector("#map"),n=document.querySelector(".ms-sf-filter-map");a.style.transition="height 0.2s ease, top 0.2s ease",a.style.height=`${t||0}px`,a.style.top=`${e}px`,n.style.transition="height 0.2s ease, top 0.2s ease",n.style.height=`${t||0}px`,n.style.top=`${e}px`},400)},[ne,xe]),e.useEffect(()=>{if(!le?.get("mapId"))return;if(me.data.length<=1)return;let e=!1;return(async()=>{const{cleanCoords:t,multiPoint:a,polygon:n,featureCollection:s,union:o,unkink:r}=await m();if(e)return;const i=me.data.map(e=>t(a(e.getPath().getArray().map(e=>[e.lat(),e.lng()]))).geometry.coordinates).filter(e=>e.length>=4).map(e=>e.map(e=>new google.maps.LatLng(e[0],e[1]))).map(e=>r(e)).flatMap(e=>e.features.map(e=>e.geometry.coordinates[0])).filter(e=>e.length>=4);if(e)return;if(i.length<2)return void Be();const l=e=>{if(!e.length)return e;const[t,a]=e[0],[n,s]=e[e.length-1];return t===n&&a===s?e:[...e,[t,a]]},c=o(s(i.map(e=>n([l(e)]))));if(c){if(me.data.forEach(e=>e.setMap(null)),"Polygon"===c.geometry.type){const e=Ie(c.geometry.coordinates[0].map(e=>new google.maps.LatLng(e[1],e[0])),le);ae(Z({initial:!1,data:[e]}))}if("MultiPolygon"===c.geometry.type){const e=[];c.geometry.coordinates.forEach(t=>{const a=t[0],n=Ie(a.map(e=>new google.maps.LatLng(e[1],e[0])),le);e.push(n)}),ae(Z({initial:!1,data:e}))}}})(),()=>{e=!0}},[me.data.length,le?.get("mapId")]),t.jsxs("div",{id:"map-container",className:`ms-sf-filter-map ${je?"-loading":""} `,children:[!ee&&ke>fe&&!ge&&t.jsxs("div",{className:"ms-sf-markers-count-alert",children:[t.jsx("span",{children:`${te("Showing")} ${K.length} ${te("of")} ${ke?.toLocaleString("en")||0} ${te("properties")}.`}),t.jsx("span",{children:te("Zoom in to see more.")})]}),t.jsxs("div",{className:"ms-sf-wrapper-draw-map-header",children:[t.jsx("span",{children:te("Draw a shape around the region(s) you would like to live in")}),t.jsx("div",{className:"ms-sf-flex",children:t.jsx("button",{className:"ms-sf-btn -cancel",onClick:Be,children:te("Cancel")})})]}),t.jsx("div",{ref:re,id:"property-info-box"}),t.jsx("div",{className:"ms-sf-map-loading-layout",children:t.jsx("div",{className:"sf-icon-map"})}),t.jsx("div",{id:"map",className:"ms-sf-filter-map"})]})};export{K as default};
function __vite__mapDeps(indexes) {
  if (!__vite__mapDeps.viteFileDeps) {
    __vite__mapDeps.viteFileDeps = []
  }
  return indexes.map((i) => __vite__mapDeps.viteFileDeps[i])
}
