import{r as e,j as t}from"./react-vendor-CnO_ZB-6.js";import{b as a}from"./state-DbALYLXJ.js";import{f as n,U as o,g as s,u as r,d as i,h as l,i as c,j as d,k as m,m as p}from"./index-DcNFHKoj.js";import{aQ as u,aR as g,b as f,a as h,aS as v,aT as w,aU as y,h as b,aV as E,aW as L,aX as k,aY as M,aZ as C,a_ as x,a$ as j,b0 as $,aI as _,j as N,aa as P,G as S,b1 as O,b2 as A,b3 as I,b4 as T,az as Z,b5 as z,b6 as H,b7 as D,aK as R,b8 as B,b9 as F,ba as V,f as U,bb as W,aL as q}from"./index-BTRB1GqJ.js";import{_ as G}from"./vendor-CMABA041.js";import"./utils-Gdk-beRS.js";import{centerMapByPoints as K,centerMapByRect as Q}from"./mapOperations-DZWFYxTu.js";import{u as X}from"./useOutsideClick-CdiqAPpl.js";import{u as Y}from"./i18n-TlBH8u-u.js";const J=e=>{const t=e.split(","),a=parseFloat(t[0]),n=parseFloat(t[1]);return{lat:(a+parseFloat(t[2]))/2,lng:(n+parseFloat(t[3]))/2}},ee=e=>!!e?.getBounds()&&!!e?.getProjection(),te=({data:te=[],isLoading:ae=!1,blurred:ne=!1})=>{const{t:oe}=Y(),se=a(),{width:re}=r(),[ie,le]=e.useState(!1),ce=e.useRef(null);X(ce,function(e){const t=document.querySelector(".ms-sf-wrapper-sorter"),a=document.querySelector("#shareModal");if(t&&t.contains(e.target)||a&&a.contains(e.target))return;const n=document.getElementById("property-info-box");if(n){const e=n.getAttribute("data-position");e&&m(e)}});const[de]=_(),{map:me,markerClusterer:pe,freeHandPolygons:ue}=f(),{currentLat:ge,currentLng:fe,zoom:he,clusterMarkersActive:ve,maxNumberMarkers:we,favoriteIcon:ye}=N(),{viewOption:be,filters:Ee,tempFilters:Le,isFirstCenter:ke,searchRunning:Me,count:Ce,defaultLocation:xe,favorites:je}=h(),{editingCriteria:$e,selectedEditCategoryId:_e}=P(),Ne=!(Ee.rect||xe.rect||Ee.polygon||Ee.keyword_main),Pe=e.useRef(!0),Se=e.useRef(ve),{draw:Oe,disable:Ae,enable:Ie,paint:Te,clear:Ze}=(()=>{const t=a(),[n,o]=e.useState(""),{freeHandPolygons:s}=f(),{loading:r}=h(),i=e.useRef(null);e.useEffect(()=>{const e=v("--ibc--idx-primary-color");o(e)},[]),e.useEffect(()=>{if(s.data.length&&!r){const e=s.data.map(e=>w(e)).join(",");if(!s.initial){const a=y();if(a.has("radius_location")){a.delete("radius_location"),a.set("polygon_search",e);const t=a.toString()?`?${a.toString()}`:window.location.pathname;window.history.replaceState(null,"",t)}t(b({polygon:e,rect:void 0,zm:void 0,keyword_main:void 0,radius_location:void 0}))}}},[s,t,r]);const l=e.useCallback((e,t)=>{const a=t.getZoom()||15,o=[];e.forEach(e=>o.push({lat:e.lat(),lng:e.lng()}));const s=((e,t)=>{let a,n,o,s,r,i,l,c,d,m,p,u,g,f,h,v,w,y,b=0;const E=Math.PI/180*.5,L=[],k=[],M=[];if(e.length<3)return e;for(b=e.length,d=360*t/(2*Math.PI*6378137),d*=d,n=0,k[0]=0,M[0]=b-1,a=1;a>0;)if(o=k[a-1],s=M[a-1],a--,s-o>1){for(m=e[s].lng-e[o].lng,p=e[s].lat-e[o].lat,Math.abs(m)>180&&(m=360-Math.abs(m)),m*=Math.cos(E*(e[s].lat+e[o].lat)),u=m*m+p*p,r=o+1,i=o,c=-1;r<s;r++)g=e[r].lng-e[o].lng,f=e[r].lat-e[o].lat,Math.abs(g)>180&&(g=360-Math.abs(g)),g*=Math.cos(E*(e[r].lat+e[o].lat)),h=g*g+f*f,v=e[r].lng-e[s].lng,w=e[r].lat-e[s].lat,Math.abs(v)>180&&(v=360-Math.abs(v)),v*=Math.cos(E*(e[r].lat+e[s].lat)),y=v*v+w*w,l=h>=u+y?y:y>=u+h?h:(g*p-f*m)*(g*p-f*m)/u,l>c&&(i=r,c=l);c<d?(L[n]=o,n++):(a++,k[a-1]=i,M[a-1]=s,a++,k[a-1]=o,M[a-1]=i)}else L[n]=o,n++;L[n]=b-1,n++;const C=[];for(let x=0;x<n;x++)C.push(e[L[x]]);return C})(o,20-a/20*19);return new google.maps.Polygon({map:t,paths:s,strokeColor:n,strokeOpacity:.8,strokeWeight:2,fillColor:n,fillOpacity:.2,clickable:!1})},[n]),c=e.useCallback((e,a)=>{s.data.forEach(e=>{e.setMap(null)}),t(E());const n=y();if(n.has("radius_location")){n.delete("radius_location");const e=n.toString()?`?${n.toString()}`:window.location.pathname;window.history.replaceState(null,"",e)}if(!a){if(e){const a=e.getCenter()?.lat()||0,n=e.getCenter()?.lng()||0,o=`${e.getZoom()||11}`,s=((e,t)=>{const a=document.getElementById("map"),n=a?.offsetWidth||window.innerWidth,o=a?.offsetHeight||window.innerHeight,s=Math.pow(2,t),r=180/(256*s)*o*1.8/2,i=360/(256*s)*n/2;return`${e.lat-r},${e.lng-i},${e.lat+r},${e.lng+i}`})({lat:a,lng:n},Number(o));t(b({rect:s,zm:o}))}t(b({polygon:void 0,keyword_main:void 0,radius_location:void 0}))}},[s,t]),d=(e,a)=>{t(k(!1)),e.setOptions({draggable:!0}),i.current&&i.current.disconnect(),a&&(t(C(!0)),x())};return{draw:e=>{const a=e=>e.preventDefault();document.body.addEventListener("touchmove",a,{passive:!1});let o=new google.maps.Polyline({map:e,clickable:!1,strokeColor:n,strokeOpacity:.8,strokeWeight:2});const s=google.maps.event.addListener(e,"mousemove",function(e){o.getPath().push(e.latLng)});google.maps.event.addListenerOnce(e,"mouseup",function(){google.maps.event.removeListener(s);const n=o.getPath(),r=n.getLength()>1;r&&(o.setMap(null),o=l(n,e),t(L(o))),google.maps.event.clearListeners(e.getDiv(),"mousedown"),google.maps.event.clearListeners(e.getDiv(),"touchstart"),d(e,!r),document.body.removeEventListener("touchmove",a),u("off")})},paint:l,disable:e=>{t(k(!0)),e.setOptions({draggable:!1}),M(),t(C(!1));const a=new MutationObserver(()=>M());a.observe(document.body,{childList:!0,subtree:!0}),i.current=a},enable:d,clear:c}})(),{draw:ze,clear:He}=(()=>{const t=a(),{polygons:n,polygonVisibility:o}=f(),[s,r]=e.useState("");return e.useEffect(()=>{n.forEach(e=>e.setVisible(o))},[n,o]),e.useEffect(()=>{const e=v("--ibc--idx-primary-color");r(e)},[]),{draw:(e,...a)=>{e&&a.forEach(a=>{const n=new google.maps.Polygon({paths:a,strokeColor:s,strokeOpacity:.8,strokeWeight:2,fillColor:s,fillOpacity:.2});t($(n)),n.setMap(e)})},clear:e.useCallback(()=>{n.forEach(e=>{e.setMap(null)}),t(j()),t(C(!0))},[n,t])}})(),[De,Re]=e.useState(null),[Be,Fe]=e.useState(null);function Ve(e){R({mlsNumber:e.mls_num,isSold:2===e.mls_status})}const Ue=i(()=>{const e=me?.getCenter(),t=e?.lat(),a=e?.lng(),n=me?.getZoom();"map"!==be||"edit"===S&&!$e||ge===t&&fe===a&&he===n||(se(B(t)),se(F(a)),se(V(n)),Pe.current?Pe.current=!1:Me?se(U(!1)):ke?se(W(!1)):Ee.polygon||Ee.keyword_main||se(b({rect:me?.getBounds()?.toUrlValue(),zm:me?.getZoom()?.toString()})))},700),We=()=>{me&&(De&&(google.maps.event.removeListener(De),Re(null)),Be&&(google.maps.event.removeListener(Be),Fe(null)),Ie(me,!0),u("off"))};function qe(e){const t=p(e,oe);q(t)}const Ge=async()=>{const e=Ee.rect||xe.rect,t=e?J(e):void 0,a=Number(Ee.zm||xe.zm),n=new google.maps.Map(document.getElementById("map"),{center:t,zoom:a,mapId:"m4p1D",zoomControl:!1,mapTypeControl:!1,scaleControl:!1,rotateControl:!1,fullscreenControl:!1,clickableIcons:!1,panControl:!1,gestureHandling:"greedy",streetViewControl:!1,minZoom:4,maxZoom:20}),o=(e=>{const t=document.createElement("button");return t.className="ms-sf-btn sf-icon-zoom ",t.ariaLabel="Zoom In",t.addEventListener("click",()=>{if(!e)return;const t=e.getZoom()+1;e.setZoom(t)}),t})(n),s=(e=>{const t=document.createElement("button");return t.className="ms-sf-btn sf-icon-min ",t.ariaLabel="Zoom Out",t.addEventListener("click",()=>{if(!e)return;const t=e.getZoom()-1;e.setZoom(t)}),t})(n),r=(e=>{const t=document.createElement("button");return t.className="ms-sf-btn sf-icon-satellite",t.ariaLabel="Satellite View",t.addEventListener("click",()=>{const a=["roadmap","satellite"];let n=0;if(a.forEach((t,a)=>{t===e.getMapTypeId()&&(n=a)}),e.setMapTypeId(a[1===n?0:n+1]),1===n)return t.classList.remove("sf-icon-guide"),void t.classList.add("sf-icon-satellite");t.classList.remove("sf-icon-satellite"),t.classList.add("sf-icon-guide")}),t})(n),i=((e,t,a)=>{const o=document.createElement("button");return o.className="ms-sf-btn sf-icon-draw ms-sf-draw-control",o.ariaLabel="Draw Area",a&&(o.style.display="none"),o.addEventListener("click",()=>{u("on"),(()=>{if(!n)return;Ae(n);const e=google.maps.event.addDomListenerOnce(n.getDiv(),"touchstart",()=>Oe(n)),t=google.maps.event.addDomListenerOnce(n.getDiv(),"mousedown",()=>Oe(n));Re(e),Fe(t)})?.()}),o})(0,0,"edit"===S),l=(e=>{const t=document.createElement("button");return t.className="ms-sf-btn sf-icon-location",t.ariaLabel="Location",t.addEventListener("click",async()=>{const{findCurrentLocation:t}=await G(()=>import("./mapOperations-DZWFYxTu.js"),__vite__mapDeps([]),import.meta.url);t(e)}),t})(n),c=document.createElement("div");c.className="ms-sf-item",c.appendChild(o),c.appendChild(s),c.appendChild(i),c.appendChild(r),c.appendChild(l);const d=document.createElement("div");if(d.className="ms-sf-wrapper-map-actions",d.appendChild(c),n.controls[google.maps.ControlPosition.TOP_RIGHT].push(d),!e&&Ee.polygon){const e=Ee.polygon.split(",").map(e=>g(e)).flatMap(e=>{const t=[];return e.forEach(e=>t.push({lat:e.lat(),lng:e.lng()})),t});K(e,n)}se(H(n))};e.useEffect(()=>{if(!me||"map"!==be||!S)return;const e=e=>{const t="new"===S||!!$e;e.style.display=t?"flex":"none",t||(We(),u("off"))},t=()=>me.getDiv().querySelector(".ms-sf-draw-control");let a=t();if(a)return void e(a);const n=me.addListener("idle",()=>{a=t(),a&&(e(a),n.remove(),s?.disconnect())}),o=me.getDiv(),s=new MutationObserver(()=>{a=t(),a&&(e(a),n.remove?.(),s.disconnect())});return s.observe(o,{childList:!0,subtree:!0}),()=>{n.remove?.(),s.disconnect()}},[me,be,$e]),e.useEffect(()=>{Ne||me||Ge()},[Ne,me]),e.useEffect(()=>{if(!me)return;const e=()=>{He()},t=e=>{const t=e,{coords:a}=t.detail;ze(me,...a)},a=e=>{const t=e,{skipFilterUpdate:a}=t.detail||{};Ze(me,a)},n=e=>{const t=e,{paths:a,shouldHide:n}=t.detail,o=a.map(e=>Te(e,me));n&&o.forEach(e=>e.setVisible(!1)),se(z({initial:!0,data:o}))},o=e=>{const t=e,{points:a}=t.detail;K(a,me)},s=e=>{const t=e,{rect:a,zm:n}=t.detail;Q({rect:a,zm:n},me)},r=e=>{const t=e,{center:a,radiusKm:n,fromUrl:o}=t.detail,s=D(a,n,64).map(e=>new google.maps.LatLng(e.lat,e.lng)),r=new google.maps.MVCArray(s),i=Te(r,me);se(o?z({initial:!0,data:[i]}):L(i));const l=new google.maps.LatLngBounds;s.forEach(e=>l.extend(e)),me.fitBounds(l)};return window.addEventListener("map:clearPolygons",e),window.addEventListener("map:drawPolygons",t),window.addEventListener("map:clearFreeHand",a),window.addEventListener("map:paintFreeHand",n),window.addEventListener("map:centerByPoints",o),window.addEventListener("map:centerByRect",s),window.addEventListener("map:drawRadius",r),()=>{window.removeEventListener("map:clearPolygons",e),window.removeEventListener("map:drawPolygons",t),window.removeEventListener("map:clearFreeHand",a),window.removeEventListener("map:paintFreeHand",n),window.removeEventListener("map:centerByPoints",o),window.removeEventListener("map:centerByRect",s),window.removeEventListener("map:drawRadius",r)}},[me,He,ze,Ie,Te,se]);const Ke=e.useMemo(()=>l(te),[te]);return e.useEffect(()=>{if(!me)return;const e=me.addListener("click",()=>c());return()=>e.remove()},[me]),e.useEffect(()=>{if(!me)return;let e=!1;return(async()=>{const{AdvancedMarkerElement:t}=await google.maps.importLibrary("marker");let a=pe;if(!a||Se.current!==ve){if(a&&(a.clearMarkers?.(!0),a.setMap(null)),a=await(async({markers:e,map:t,markerGrouping:a=!1})=>{const{AdvancedMarkerElement:o}=await google.maps.importLibrary("marker"),{MarkerClusterer:s,SuperClusterAlgorithm:r}=await n(),i=new s({markers:e,map:t,algorithm:new r({maxZoom:a&&14,radius:120}),renderer:{render:({markers:e,position:t})=>(({amount:e,position:t,AdvancedMarkerElement:a})=>{const n=document.createElement("div");n.className="MarkerClustererElement";const o=Math.min(e+26,50);return n.style.height=o+10+"px",n.style.width=o+10+"px",n.innerHTML=`\n    <div \n      style="width: ${o}px; height: ${o}px;"\n    >\n      ${e}\n    </div>\n    `,new a({position:t,content:n})})({position:t,amount:e?.length||0,AdvancedMarkerElement:o})}});return i})({markers:[],map:me,markerGrouping:ve}),Se.current=ve,e)return;se(O(a))}const r=Ke.map(e=>function({properties:e,AdvancedMarkerElement:t,handleClick:a,favoriteIcon:n,favoriteCTA:r,shareCTA:i,t:l,attachToMap:c=!1,map:d}){const m=e[0],p=`${m.lat},${m.lng}`,u=document.createElement("div");if(u.className="ms-sf-richmarker",u.id=p,u.title=e.map(({mls_num:e})=>e).join(","),e.length>1)u.innerHTML=`<span class="ms-sf-price">${e.length} ${l("Units")}</span>`;else{const e=2===m.mls_status?m.price_sold||0:m.price,t=null===m?.reduced_price||isNaN(m?.reduced_price)?0:m?.reduced_price;u.innerHTML=`\n      <span class="ms-sf-price">\n        ${0===e?"N/A":o.format(e)}\n        ${t?`<i class="sf-icon-arrow-back ${t<0?"-down":"-up"}"></i>`:""}\n      </span>`}const g=new t({position:{lat:Number(m.lat),lng:Number(m.lng)},content:u,...c&&d?{map:d}:{}});return g.addListener("click",()=>s({properties:e,favoriteIcon:n,favoriteCTA:r,shareCTA:i,handleClick:a,t:l})),g}({properties:e,AdvancedMarkerElement:t,handleClick:Ve,favoriteIcon:ye,favoriteCTA:de,shareCTA:qe,t:oe,attachToMap:!1})),i=(e=>e.filter(e=>!!e.position))(r);if("function"==typeof a.setMarkers)a.setMarkers(i);else if(a.clearMarkers?.(!0),i.length>0){a.addMarkers?.(i,!0);const e=()=>{ee(me)&&i.length>0&&a.render()};ee(me)?e():google.maps.event.addListenerOnce(me,"idle",e)}else ee(me)&&a.render();le(!0)})(),()=>{e=!0}},[me,Ke,ve]),e.useEffect(()=>{pe&&(ie||je)&&((pe?.markers||[]).forEach(e=>{const t=e.targetElement,a=A(t);if(!a)return;const n=a.split(",");if(!(n.length>1)){const e=n.some(e=>!!je[e]);I(t,ye,e)}n.forEach(e=>{T(e,!!je[e])}),t.onclick=()=>{n.forEach(e=>{T(e,!!je[e])})}}),le(!1))},[je,ye,pe,ie]),e.useEffect(()=>{!me||te.length||!Ee.keyword_main||Ee.rect||xe.rect||Ee.zm||xe.zm||!Object.entries(Le).length||(me.setCenter(J(`${Le.rect}`)),me.setZoom(Number(Le.zm)))},[me,te,Ee,Le]),e.useEffect(()=>{let e;return me&&(e=me.addListener("bounds_changed",Ue)),()=>{e?.remove()}},[me,se,Ue]),e.useEffect(()=>{setTimeout(()=>{const e=Z("all"),t=window.innerHeight-e,a=document.querySelector("#map"),n=document.querySelector(".ms-sf-filter-map");a.style.transition="height 0.2s ease, top 0.2s ease",a.style.height=`${t||0}px`,a.style.top=`${e}px`,n.style.transition="height 0.2s ease, top 0.2s ease",n.style.height=`${t||0}px`,n.style.top=`${e}px`},400)},[re,_e]),e.useEffect(()=>{if(!me?.get("mapId"))return;if(ue.data.length<=1)return;let e=!1;return(async()=>{const{cleanCoords:t,multiPoint:a,polygon:n,featureCollection:o,union:s,unkink:r}=await d();if(e)return;const i=ue.data.map(e=>t(a(e.getPath().getArray().map(e=>[e.lat(),e.lng()]))).geometry.coordinates).filter(e=>e.length>=4).map(e=>e.map(e=>new google.maps.LatLng(e[0],e[1]))).map(e=>r(e)).flatMap(e=>e.features.map(e=>e.geometry.coordinates[0])).filter(e=>e.length>=4);if(e)return;if(i.length<2)return void We();const l=e=>{if(!e.length)return e;const[t,a]=e[0],[n,o]=e[e.length-1];return t===n&&a===o?e:[...e,[t,a]]},c=s(o(i.map(e=>n([l(e)]))));if(c){if(ue.data.forEach(e=>e.setMap(null)),"Polygon"===c.geometry.type){const e=Te(c.geometry.coordinates[0].map(e=>new google.maps.LatLng(e[1],e[0])),me);se(z({initial:!1,data:[e]}))}if("MultiPolygon"===c.geometry.type){const e=[];c.geometry.coordinates.forEach(t=>{const a=t[0],n=Te(a.map(e=>new google.maps.LatLng(e[1],e[0])),me);e.push(n)}),se(z({initial:!1,data:e}))}}})(),()=>{e=!0}},[ue.data.length,me?.get("mapId")]),t.jsxs("div",{id:"map-container",className:`ms-sf-filter-map ${Ne?"-loading":""} `,children:[!ae&&Ce>we&&!ve&&t.jsxs("div",{className:"ms-sf-markers-count-alert",children:[t.jsx("span",{children:`${oe("Showing")} ${te.length} ${oe("of")} ${Ce?.toLocaleString("en")||0} ${oe("properties")}.`}),t.jsx("span",{children:oe("Zoom in to see more.")})]}),t.jsxs("div",{className:"ms-sf-wrapper-draw-map-header",children:[t.jsx("span",{children:oe("Draw a shape around the region(s) you would like to live in")}),t.jsx("div",{className:"ms-sf-flex",children:t.jsx("button",{className:"ms-sf-btn -cancel",onClick:We,children:oe("Cancel")})})]}),t.jsx("div",{ref:ce,id:"property-info-box"}),t.jsx("div",{className:"ms-sf-map-loading-layout",children:t.jsx("div",{className:"sf-icon-map"})}),t.jsx("div",{id:"map",className:"ms-sf-filter-map "+(ne?"-blurred":"")})]})};export{te as default};
function __vite__mapDeps(indexes) {
  if (!__vite__mapDeps.viteFileDeps) {
    __vite__mapDeps.viteFileDeps = []
  }
  return indexes.map((i) => __vite__mapDeps.viteFileDeps[i])
}
